"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.QRpcServer = void 0;

var _ws = _interopRequireDefault(require("ws"));

var _arango = _interopRequireDefault(require("./arango"));

var _arangoCollection = require("./arango-collection");

var _auth = require("./auth");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class QRpcServer {
  constructor(options) {
    this.db = options.db;
    this.auth = options.auth;
    this.resolvers = new Map();
    this.db.collections.forEach(c => {
      this.resolvers.set(c.name, c.queryResolver());
    });
    this.port = options.port || 0;
  }

  start() {
    if (this.port === 0) {
      throw new Error('QRpcServer port hasn\'t specified');
    }

    this.wss = new _ws.default.Server({
      port: this.port
    });
    this.wss.on('connection', (ws, req) => {
      const connection = {
        socket: ws,
        remoteAddress: req.connection.remoteAddress
      };
      ws.on('close', () => {});
      ws.on('message', data => {
        (async () => {
          try {
            await this.rpc(connection, data);
          } catch (error) {
            console.error(error);
          }
        })();
      });
    });
  }

  async rpc(connection, data) {
    const request = JSON.parse(data);
    let response;

    try {
      response = {
        jsonrpc: '2.0',
        id: request.id,
        result: await this.dispatch(connection, request.method, request.params)
      };
    } catch (error) {
      response = {
        jsonrpc: '2.0',
        id: request.id,
        error: {
          code: error.code || 500,
          message: error.message
        }
      };
    }

    connection.socket.send(JSON.stringify(response));
  }

  async dispatch(connection, method, params) {
    switch (method) {
      case 'transactions':
      case 'accounts':
      case 'blocks':
      case 'messages':
      case 'block_signatures':
        return this.query(connection, this.db.collectionsByName.get(method), params);

      default:
        throw new Error(`Unknown method [${method}]`);
    }
  }

  async query(connection, collection, params) {
    const resolver = this.resolvers.get(collection.name);
    const docs = await resolver(null, params, {
      auth: this.auth,
      remoteAddress: connection.remoteAddress
    }, {
      operation: {
        selectionSet: params.selection
      }
    });
    return docs;
  }

}

exports.QRpcServer = QRpcServer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9xLXJwYy1zZXJ2ZXIuanMiXSwibmFtZXMiOlsiUVJwY1NlcnZlciIsImNvbnN0cnVjdG9yIiwib3B0aW9ucyIsImRiIiwiYXV0aCIsInJlc29sdmVycyIsIk1hcCIsImNvbGxlY3Rpb25zIiwiZm9yRWFjaCIsImMiLCJzZXQiLCJuYW1lIiwicXVlcnlSZXNvbHZlciIsInBvcnQiLCJzdGFydCIsIkVycm9yIiwid3NzIiwiV2ViU29ja2V0IiwiU2VydmVyIiwib24iLCJ3cyIsInJlcSIsImNvbm5lY3Rpb24iLCJzb2NrZXQiLCJyZW1vdGVBZGRyZXNzIiwiZGF0YSIsInJwYyIsImVycm9yIiwiY29uc29sZSIsInJlcXVlc3QiLCJKU09OIiwicGFyc2UiLCJyZXNwb25zZSIsImpzb25ycGMiLCJpZCIsInJlc3VsdCIsImRpc3BhdGNoIiwibWV0aG9kIiwicGFyYW1zIiwiY29kZSIsIm1lc3NhZ2UiLCJzZW5kIiwic3RyaW5naWZ5IiwicXVlcnkiLCJjb2xsZWN0aW9uc0J5TmFtZSIsImdldCIsImNvbGxlY3Rpb24iLCJyZXNvbHZlciIsImRvY3MiLCJvcGVyYXRpb24iLCJzZWxlY3Rpb25TZXQiLCJzZWxlY3Rpb24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFDQTs7OztBQTBDTyxNQUFNQSxVQUFOLENBQWlCO0FBTXBCQyxFQUFBQSxXQUFXLENBQUNDLE9BQUQsRUFJUjtBQUNDLFNBQUtDLEVBQUwsR0FBVUQsT0FBTyxDQUFDQyxFQUFsQjtBQUNBLFNBQUtDLElBQUwsR0FBWUYsT0FBTyxDQUFDRSxJQUFwQjtBQUNBLFNBQUtDLFNBQUwsR0FBaUIsSUFBSUMsR0FBSixFQUFqQjtBQUNBLFNBQUtILEVBQUwsQ0FBUUksV0FBUixDQUFvQkMsT0FBcEIsQ0FBNkJDLENBQUQsSUFBTztBQUMvQixXQUFLSixTQUFMLENBQWVLLEdBQWYsQ0FBbUJELENBQUMsQ0FBQ0UsSUFBckIsRUFBMkJGLENBQUMsQ0FBQ0cs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L0QsRUFBb0Y7QUFDaEYsVUFBTVMsUUFLVSxHQUFHLEtBQUsxQyxTQUFMLENBQWV3QyxHQUFmLENBQW1CQyxVQUFVLENBQUNuQyxJQUE5QixDQUxuQjtBQU1BLFVBQU1xQyxJQUFJLEdBQUcsTUFBTUQsUUFBUSxDQUN2QixJQUR1QixFQUV2QlQsTUFGdUIsRUFHdkI7QUFDSWxDLE1BQUFBLElBQUksRUFBRSxLQUFLQSxJQURmO0FBRUlvQixNQUFBQSxhQUFhLEVBQUVGLFVBQVUsQ0FBQ0U7QUFGOUIsS0FIdUIsRUFPdkI7QUFDSXlCLE1BQUFBLFNBQVMsRUFBRTtBQUNQQyxRQUFBQSxZQUFZLEVBQUVaLE1BQU0sQ0FBQ2E7QUFEZDtBQURmLEtBUHVCLENBQTNCO0FBWUEsV0FBT0gsSUFBUDtBQUNIOztBQW5HbUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgV2ViU29ja2V0IGZyb20gJ3dzJztcbmltcG9ydCBBcmFuZ28gZnJvbSAnLi9hcmFuZ28nO1xuaW1wb3J0IHR5cGUge0dyYXBoUUxSZXF1ZXN0Q29udGV4dH0gZnJvbSAnLi9hcmFuZ28tY29sbGVjdGlvbic7XG5pbXBvcnQge0NvbGxlY3Rpb259IGZyb20gJy4vYXJhbmdvLWNvbGxlY3Rpb24nO1xuaW1wb3J0IHtBdXRofSBmcm9tICcuL2F1dGgnO1xuaW1wb3J0IHR5cGUge0ZpZWxkU2VsZWN0aW9uLCBPcmRlckJ5fSBmcm9tICcuL2RiLXR5cGVzJztcblxudHlwZSBScGNSZXF1ZXN0ID0ge1xuICAgIGpzb25ycGM6ICcyLjAnLFxuICAgIG1ldGhvZDogc3RyaW5nLFxuICAgIHBhcmFtcz86IGFueSxcbiAgICBpZD86IHN0cmluZyB8IG51bWJlciB8IG51bGwsXG59XG5cbnR5cGUgUnBjUmVzdWx0ID0ge1xuICAgIHJlc3VsdDogYW55XG59XG5cbnR5cGUgUnBjRXJyb3IgPSB7XG4gICAgZXJyb3I6IHtcbiAgICAgICAgY29kZTogbnVtYmVyLFxuICAgICAgICBtZXNzYWdlOiBzdHJpbmcsXG4gICAgICAgIGRhdGE/OiBhbnlcbiAgICB9XG59XG5cbnR5cGUgUnBjUmVzcG9uc2UgPSB7XG4gICAganNvbnJwYzogJzIuMCcsXG4gICAgaWQ6IHN0cmluZyB8IG51bWJlciB8IG51bGwsXG59ICYgKFJwY1Jlc3VsdCB8IFJwY0Vycm9yKVxuXG50eXBlIFF1ZXJ5UGFyYW1zID0ge1xuICAgIGZpbHRlcjogYW55LFxuICAgIHNlbGVjdGlvbjogRmllbGRTZWxlY3Rpb25bXSxcbiAgICBvcmRlckJ5PzogT3JkZXJCeVtdLFxuICAgIGxpbWl0PzogbnVtYmVyLFxuICAgIHRpbWVvdXQ/OiBudW1iZXIsXG4gICAgYWNjZXNzS2V5Pzogc3RyaW5nLFxuICAgIG9wZXJhdGlvbklkPzogc3RyaW5nLFxufVxuXG50eXBlIFJwY0Nvbm5lY3Rpb24gPSB7XG4gICAgc29ja2V0OiBXZWJTb2NrZXQsXG4gICAgcmVtb3RlQWRkcmVzczogc3RyaW5nLFxufVxuXG5leHBvcnQgY2xhc3MgUVJwY1NlcnZlciB7XG4gICAgZGI6IEFyYW5nbztcbiAgICBhdXRoOiBBdXRoO1xuICAgIHJlc29sdmVyczogTWFwPHN0cmluZywgKCkgPT4gUHJvbWlzZT47XG4gICAgcG9ydDogbnVtYmVyO1xuXG4gICAgY29uc3RydWN0b3Iob3B0aW9uczoge1xuICAgICAgICBkYjogQXJhbmdvLFxuICAgICAgICBhdXRoOiBBdXRoLFxuICAgICAgICBwb3J0PzogbnVtYmVyLFxuICAgIH0pIHtcbiAgICAgICAgdGhpcy5kYiA9IG9wdGlvbnMuZGI7XG4gICAgICAgIHRoaXMuYXV0aCA9IG9wdGlvbnMuYXV0aDtcbiAgICAgICAgdGhpcy5yZXNvbHZlcnMgPSBuZXcgTWFwKCk7XG4gICAgICAgIHRoaXMuZGIuY29sbGVjdGlvbnMuZm9yRWFjaCgoYykgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZXNvbHZlcnMuc2V0KGMubmFtZSwgYy5xdWVyeVJlc29sdmVyKCkpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5wb3J0ID0gb3B0aW9ucy5wb3J0IHx8IDA7XG4gICAgfVxuXG4gICAgc3RhcnQoKSB7XG4gICAgICAgIGlmICh0aGlzLnBvcnQgPT09IDApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignUVJwY1NlcnZlciBwb3J0IGhhc25cXCd0IHNwZWNpZmllZCcpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMud3NzID0gbmV3IFdlYlNvY2tldC5TZXJ2ZXIoe3BvcnQ6IHRoaXMucG9ydH0pO1xuICAgICAgICB0aGlzLndzcy5vbignY29ubmVjdGlvbicsICh3cywgcmVxKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb25uZWN0aW9uOiBScGNDb25uZWN0aW9uID0ge1xuICAgICAgICAgICAgICAgIHNvY2tldDogd3MsXG4gICAgICAgICAgICAgICAgcmVtb3RlQWRkcmVzczogcmVxLmNvbm5lY3Rpb24ucmVtb3RlQWRkcmVzcyxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB3cy5vbignY2xvc2UnLCAoKSA9PiB7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHdzLm9uKCdtZXNzYWdlJywgKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICAoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5ycGMoY29ubmVjdGlvbiwgZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgcnBjKGNvbm5lY3Rpb246IFJwY0Nvbm5lY3Rpb24sIGRhdGE6IGFueSkge1xuICAgICAgICBjb25zdCByZXF1ZXN0OiBScGNSZXF1ZXN0ID0gSlNPTi5wYXJzZShkYXRhKTtcbiAgICAgICAgbGV0IHJlc3BvbnNlOiBScGNSZXNwb25zZTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJlc3BvbnNlID0ge1xuICAgICAgICAgICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICAgICAgICAgIGlkOiByZXF1ZXN0LmlkLFxuICAgICAgICAgICAgICAgIHJlc3VsdDogYXdhaXQgdGhpcy5kaXNwYXRjaChjb25uZWN0aW9uLCByZXF1ZXN0Lm1ldGhvZCwgcmVxdWVzdC5wYXJhbXMpLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJlc3BvbnNlID0ge1xuICAgICAgICAgICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICAgICAgICAgIGlkOiByZXF1ZXN0LmlkLFxuICAgICAgICAgICAgICAgIGVycm9yOiB7XG4gICAgICAgICAgICAgICAgICAgIGNvZGU6IGVycm9yLmNvZGUgfHwgNTAwLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY29ubmVjdGlvbi5zb2NrZXQuc2VuZChKU09OLnN0cmluZ2lmeShyZXNwb25zZSkpO1xuICAgIH1cblxuICAgIGFzeW5jIGRpc3BhdGNoKGNvbm5lY3Rpb246IFJwY0Nvbm5lY3Rpb24sIG1ldGhvZDogc3RyaW5nLCBwYXJhbXM6IGFueSkge1xuICAgICAgICBzd2l0Y2ggKG1ldGhvZCkge1xuICAgICAgICBjYXNlICd0cmFuc2FjdGlvbnMnOlxuICAgICAgICBjYXNlICdhY2NvdW50cyc6XG4gICAgICAgIGNhc2UgJ2Jsb2Nrcyc6XG4gICAgICAgIGNhc2UgJ21lc3NhZ2VzJzpcbiAgICAgICAgY2FzZSAnYmxvY2tfc2lnbmF0dXJlcyc6XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5xdWVyeShjb25uZWN0aW9uLCB0aGlzLmRiLmNvbGxlY3Rpb25zQnlOYW1lLmdldChtZXRob2QpLCBwYXJhbXMpO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmtub3duIG1ldGhvZCBbJHttZXRob2R9XWApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgcXVlcnkoY29ubmVjdGlvbjogUnBjQ29ubmVjdGlvbiwgY29sbGVjdGlvbjogQ29sbGVjdGlvbiwgcGFyYW1zOiBRdWVyeVBhcmFtcykge1xuICAgICAgICBjb25zdCByZXNvbHZlcjogKFxuICAgICAgICAgICAgcGFyZW50OiBhbnksXG4gICAgICAgICAgICBhcmdzOiBhbnksXG4gICAgICAgICAgICBjb250ZXh0OiBHcmFwaFFMUmVxdWVzdENvbnRleHQsXG4gICAgICAgICAgICBpbmZvOiBhbnksXG4gICAgICAgICkgPT4gUHJvbWlzZTxbXT4gPSB0aGlzLnJlc29sdmVycy5nZXQoY29sbGVjdGlvbi5uYW1lKTtcbiAgICAgICAgY29uc3QgZG9jcyA9IGF3YWl0IHJlc29sdmVyKFxuICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgIHBhcmFtcyxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBhdXRoOiB0aGlzLmF1dGgsXG4gICAgICAgICAgICAgICAgcmVtb3RlQWRkcmVzczogY29ubmVjdGlvbi5yZW1vdGVBZGRyZXNzLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBvcGVyYXRpb246IHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uU2V0OiBwYXJhbXMuc2VsZWN0aW9uLFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gZG9jcztcbiAgICB9XG59XG4iXX0=