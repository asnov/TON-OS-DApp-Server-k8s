"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Auth = exports.deniedAccess = exports.grantedAccess = void 0;

var _nodeFetch = _interopRequireDefault(require("node-fetch"));

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const grantedAccess = Object.freeze({
  granted: true,
  restrictToAccounts: []
});
exports.grantedAccess = grantedAccess;
const deniedAccess = Object.freeze({
  granted: false,
  restrictToAccounts: []
});
exports.deniedAccess = deniedAccess;

class Auth {
  constructor(config) {
    this.config = config;
  }

  static extractAccessKey(req, connection) {
    return req && req.headers && (req.headers.accessKey || req.headers.accesskey) || connection && connection.context && connection.context.accessKey;
  }

  static unauthorizedError() {
    return _utils.QError.unauthorized();
  }

  authServiceRequired() {
    if (!this.config.authorization.endpoint) {
      throw _utils.QError.authServiceUnavailable();
    }
  }

  async requireGrantedAccess(accessKey) {
    const access = await this.getAccessRights(accessKey);

    if (!access.granted) {
      throw Auth.unauthorizedError();
    }

    return access;
  }

  async getAccessRights(accessKey) {
    if (!this.config.authorization.endpoint) {
      return grantedAccess;
    }

    if ((accessKey || '') === '') {
      return deniedAccess;
    }

    const rights = await this.invokeAuth('getAccessRights', {
      accessKey
    });

    if (!rights.restrictToAccounts) {
      rights.restrictToAccounts = [];
    }

    return rights;
  }

  async getManagementAccessKey() {
    this.authServiceRequired();
    return this.invokeAuth('getManagementAccessKey', {});
  }

  async registerAccessKeys(account, keys, signedManagementAccessKey) {
    this.authServiceRequired();
    return this.invokeAuth('registerAccessKeys', {
      account,
      keys,
      signedManagementAccessKey
    });
  }

  async revokeAccessKeys(account, keys, signedManagementAccessKey) {
    this.authServiceRequired();
    return this.invokeAuth('revokeAccessKeys', {
      account,
      keys,
      signedManagementAccessKey
    });
  }

  async invokeAuth(method, params) {
    const res = await (0, _nodeFetch.default)(this.config.authorization.endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        jsonrpc: '2.0',
        id: '1',
        method,
        params
      })
    });

    if (res.status !== 200) {
      throw new Error(`Auth service failed: ${await res.text()}`);
    }

    const response = await res.json();

    if (response.error) {
      throw _utils.QError.auth(response.error);
    }

    return response.result;
  }

}

exports.Auth = Auth;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9hdXRoLmpzIl0sIm5hbWVzIjpbImdyYW50ZWRBY2Nlc3MiLCJPYmplY3QiLCJmcmVlemUiLCJncmFudGVkIiwicmVzdHJpY3RUb0FjY291bnRzIiwiZGVuaWVkQWNjZXNzIiwiQXV0aCIsImNvbnN0cnVjdG9yIiwiY29uZmlnIiwiZXh0cmFjdEFjY2Vzc0tleSIsInJlcSIsImNvbm5lY3Rpb24iLCJoZWFkZXJzIiwiYWNjZXNzS2V5IiwiYWNjZXNza2V5IiwiY29udGV4dCIsInVuYXV0aG9yaXplZEVycm9yIiwiUUVycm9yIiwidW5hdXRob3JpemVkIiwiYXV0aFNlcnZpY2VSZXF1aXJlZCIsImF1dGhvcml6YXRpb24iLCJlbmRwb2ludCIsImF1dGhTZXJ2aWNlVW5hdmFpbGFibGUiLCJyZXF1aXJlR3JhbnRlZEFjY2VzcyIsImFjY2VzcyIsImdldEFjY2Vzc1JpZ2h0cyIsInJpZ2h0cyIsImludm9rZUF1dGgiLCJnZXRNYW5hZ2VtZW50QWNjZXNzS2V5IiwicmVnaXN0ZXJBY2Nlc3NLZXlzIiwiYWNjb3VudCIsImtleXMiLCJzaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5IiwicmV2b2tlQWNjZXNzS2V5cyIsIm1ldGhvZCIsInBhcmFtcyIsInJlcyIsImJvZHkiLCJKU09OIiwic3RyaW5naWZ5IiwianNvbnJwYyIsImlkIiwic3RhdHVzIiwiRXJyb3IiLCJ0ZXh0IiwicmVzcG9uc2UiLCJqc29uIiwiZXJyb3IiLCJhdXRoIiwicmVzdWx0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBR0E7O0FBQ0E7Ozs7QUFZTyxNQUFNQSxhQUEyQixHQUFHQyxNQUFNLENBQUNDLE1BQVAsQ0FBYztBQUNyREMsRUFBQUEsT0FBTyxFQUFFLElBRDRDO0FBRXJEQyxFQUFBQSxrQkFBa0IsRUFBRTtBQUZpQyxDQUFkLENBQXBDOztBQUtBLE1BQU1DLFlBQTBCLEdBQUdKLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjO0FBQ3BEQyxFQUFBQSxPQUFPLEVBQUUsS0FE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QURYLE9BRitDO0FBS3hEeUIsTUFBQUEsSUFBSSxFQUFFQyxJQUFJLENBQUNDLFNBQUwsQ0FBZTtBQUNqQkMsUUFBQUEsT0FBTyxFQUFFLEtBRFE7QUFFakJDLFFBQUFBLEVBQUUsRUFBRSxHQUZhO0FBR2pCUCxRQUFBQSxNQUhpQjtBQUlqQkMsUUFBQUE7QUFKaUIsT0FBZjtBQUxrRCxLQUExQyxDQUFsQjs7QUFhQSxRQUFJQyxHQUFHLENBQUNNLE1BQUosS0FBZSxHQUFuQixFQUF3QjtBQUNwQixZQUFNLElBQUlDLEtBQUosQ0FBVyx3QkFBdUIsTUFBTVAsR0FBRyxDQUFDUSxJQUFKLEVBQVcsRUFBbkQsQ0FBTjtBQUNIOztBQUVELFVBQU1DLFFBQVEsR0FBRyxNQUFNVCxHQUFHLENBQUNVLElBQUosRUFBdkI7O0FBQ0EsUUFBSUQsUUFBUSxDQUFDRSxLQUFiLEVBQW9CO0FBQ2hCLFlBQU05QixjQUFPK0IsSUFBUCxDQUFZSCxRQUFRLENBQUNFLEtBQXJCLENBQU47QUFDSDs7QUFFRCxXQUFPRixRQUFRLENBQUNJLE1BQWhCO0FBQ0g7O0FBckdhIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHR5cGUgeyBRQ29uZmlnIH0gZnJvbSBcIi4vY29uZmlnXCI7XG5pbXBvcnQgZmV0Y2ggZnJvbSAnbm9kZS1mZXRjaCc7XG5pbXBvcnQgeyBRRXJyb3IgfSBmcm9tIFwiLi91dGlsc1wiO1xuXG5leHBvcnQgdHlwZSBBY2Nlc3NLZXkgPSB7XG4gICAga2V5OiBzdHJpbmcsXG4gICAgcmVzdHJpY3RUb0FjY291bnRzPzogc3RyaW5nW10sXG59XG5cbmV4cG9ydCB0eXBlIEFjY2Vzc1JpZ2h0cyA9IHtcbiAgICBncmFudGVkOiBib29sLFxuICAgIHJlc3RyaWN0VG9BY2NvdW50czogc3RyaW5nW10sXG59XG5cbmV4cG9ydCBjb25zdCBncmFudGVkQWNjZXNzOiBBY2Nlc3NSaWdodHMgPSBPYmplY3QuZnJlZXplKHtcbiAgICBncmFudGVkOiB0cnVlLFxuICAgIHJlc3RyaWN0VG9BY2NvdW50czogW10sXG59KTtcblxuZXhwb3J0IGNvbnN0IGRlbmllZEFjY2VzczogQWNjZXNzUmlnaHRzID0gT2JqZWN0LmZyZWV6ZSh7XG4gICAgZ3JhbnRlZDogZmFsc2UsXG4gICAgcmVzdHJpY3RUb0FjY291bnRzOiBbXSxcbn0pO1xuXG5leHBvcnQgY2xhc3MgQXV0aCB7XG4gICAgY29uZmlnOiBRQ29uZmlnO1xuXG4gICAgY29uc3RydWN0b3IoY29uZmlnOiBRQ29uZmlnKSB7XG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgIH1cblxuICAgIHN0YXRpYyBleHRyYWN0QWNjZXNzS2V5KHJlcTogYW55LCBjb25uZWN0aW9uOiBhbnkpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gKHJlcSAmJiByZXEuaGVhZGVycyAmJiAocmVxLmhlYWRlcnMuYWNjZXNzS2V5IHx8IHJlcS5oZWFkZXJzLmFjY2Vzc2tleSkpXG4gICAgICAgICAgICB8fCAoY29ubmVjdGlvbiAmJiBjb25uZWN0aW9uLmNvbnRleHQgJiYgY29ubmVjdGlvbi5jb250ZXh0LmFjY2Vzc0tleSk7XG4gICAgfVxuXG4gICAgc3RhdGljIHVuYXV0aG9yaXplZEVycm9yKCk6IEVycm9yIHtcbiAgICAgICAgcmV0dXJuIFFFcnJvci51bmF1dGhvcml6ZWQoKTtcbiAgICB9XG5cbiAgICBhdXRoU2VydmljZVJlcXVpcmVkKCkge1xuICAgICAgICBpZiAoIXRoaXMuY29uZmlnLmF1dGhvcml6YXRpb24uZW5kcG9pbnQpIHtcbiAgICAgICAgICAgIHRocm93IFFFcnJvci5hdXRoU2VydmljZVVuYXZhaWxhYmxlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyByZXF1aXJlR3JhbnRlZEFjY2VzcyhhY2Nlc3NLZXk6IHN0cmluZyB8IHR5cGVvZiB1bmRlZmluZWQpOiBQcm9taXNlPEFjY2Vzc1JpZ2h0cz4ge1xuICAgICAgICBjb25zdCBhY2Nlc3MgPSBhd2FpdCB0aGlzLmdldEFjY2Vzc1JpZ2h0cyhhY2Nlc3NLZXkpO1xuICAgICAgICBpZiAoIWFjY2Vzcy5ncmFudGVkKSB7XG4gICAgICAgICAgICB0aHJvdyBBdXRoLnVuYXV0aG9yaXplZEVycm9yKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFjY2VzcztcbiAgICB9XG5cbiAgICBhc3luYyBnZXRBY2Nlc3NSaWdodHMoYWNjZXNzS2V5OiBzdHJpbmcgfCB0eXBlb2YgdW5kZWZpbmVkKTogUHJvbWlzZTxBY2Nlc3NSaWdodHM+IHtcbiAgICAgICAgaWYgKCF0aGlzLmNvbmZpZy5hdXRob3JpemF0aW9uLmVuZHBvaW50KSB7XG4gICAgICAgICAgICByZXR1cm4gZ3JhbnRlZEFjY2VzcztcbiAgICAgICAgfVxuICAgICAgICBpZiAoKGFjY2Vzc0tleSB8fCAnJykgPT09ICcnKSB7XG4gICAgICAgICAgICByZXR1cm4gZGVuaWVkQWNjZXNzO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJpZ2h0cyA9IGF3YWl0IHRoaXMuaW52b2tlQXV0aCgnZ2V0QWNjZXNzUmlnaHRzJywge1xuICAgICAgICAgICAgYWNjZXNzS2V5LFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKCFyaWdodHMucmVzdHJpY3RUb0FjY291bnRzKSB7XG4gICAgICAgICAgICByaWdodHMucmVzdHJpY3RUb0FjY291bnRzID0gW107XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJpZ2h0cztcbiAgICB9XG5cbiAgICBhc3luYyBnZXRNYW5hZ2VtZW50QWNjZXNzS2V5KCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgICAgIHRoaXMuYXV0aFNlcnZpY2VSZXF1aXJlZCgpO1xuICAgICAgICByZXR1cm4gdGhpcy5pbnZva2VBdXRoKCdnZXRNYW5hZ2VtZW50QWNjZXNzS2V5Jywge30pO1xuICAgIH1cblxuICAgIGFzeW5jIHJlZ2lzdGVyQWNjZXNzS2V5cyhcbiAgICAgICAgYWNjb3VudDogc3RyaW5nLFxuICAgICAgICBrZXlzOiBBY2Nlc3NLZXlbXSxcbiAgICAgICAgc2lnbmVkTWFuYWdlbWVudEFjY2Vzc0tleTogc3RyaW5nXG4gICAgKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICAgICAgdGhpcy5hdXRoU2VydmljZVJlcXVpcmVkKCk7XG4gICAgICAgIHJldHVybiB0aGlzLmludm9rZUF1dGgoJ3JlZ2lzdGVyQWNjZXNzS2V5cycsIHtcbiAgICAgICAgICAgIGFjY291bnQsXG4gICAgICAgICAgICBrZXlzLFxuICAgICAgICAgICAgc2lnbmVkTWFuYWdlbWVudEFjY2Vzc0tleVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyByZXZva2VBY2Nlc3NLZXlzKFxuICAgICAgICBhY2NvdW50OiBzdHJpbmcsXG4gICAgICAgIGtleXM6IHN0cmluZ1tdLFxuICAgICAgICBzaWduZWRNYW5hZ2VtZW50QWNjZXNzS2V5OiBzdHJpbmdcbiAgICApOiBQcm9taXNlPG51bWJlcj4ge1xuICAgICAgICB0aGlzLmF1dGhTZXJ2aWNlUmVxdWlyZWQoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW52b2tlQXV0aCgncmV2b2tlQWNjZXNzS2V5cycsIHtcbiAgICAgICAgICAgIGFjY291bnQsXG4gICAgICAgICAgICBrZXlzLFxuICAgICAgICAgICAgc2lnbmVkTWFuYWdlbWVudEFjY2Vzc0tleVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBpbnZva2VBdXRoKG1ldGhvZDogc3RyaW5nLCBwYXJhbXM6IGFueSk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKHRoaXMuY29uZmlnLmF1dGhvcml6YXRpb24uZW5kcG9pbnQsIHtcbiAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgICAgIGpzb25ycGM6ICcyLjAnLFxuICAgICAgICAgICAgICAgIGlkOiAnMScsXG4gICAgICAgICAgICAgICAgbWV0aG9kLFxuICAgICAgICAgICAgICAgIHBhcmFtc1xuICAgICAgICAgICAgfSksXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChyZXMuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQXV0aCBzZXJ2aWNlIGZhaWxlZDogJHthd2FpdCByZXMudGV4dCgpfWApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXMuanNvbigpO1xuICAgICAgICBpZiAocmVzcG9uc2UuZXJyb3IpIHtcbiAgICAgICAgICAgIHRocm93IFFFcnJvci5hdXRoKHJlc3BvbnNlLmVycm9yKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXNwb25zZS5yZXN1bHQ7XG4gICAgfVxuXG59XG4iXX0=