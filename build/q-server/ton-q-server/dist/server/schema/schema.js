"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.parseTypeDef = parseTypeDef;
exports.Def = void 0;

/* eslint-disable no-use-before-define */
// Def
const Def = {
  void_(doc) {
    return {
      _void: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  any(doc) {
    return {
      _any: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  int(doc) {
    return {
      _int: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  float(doc) {
    return {
      _float: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  string(doc) {
    return {
      _string: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  bool(doc) {
    return {
      _bool: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  time(doc) {
    return {
      _time: {},
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  arrayOf(item, doc) {
    return {
      _array: item,
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  unionOf(members, doc) {
    return {
      _union: members,
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  ref(nameOrType, doc) {
    const name = typeof nameOrType === 'string' ? nameOrType : Object.keys(nameOrType)[0];
    return {
      _ref: name,
      ...(doc ? {
        _doc: doc
      } : {})
    };
  },

  value(value, doc) {
    return {
      _value: value,
      ...(doc ? {
        _doc: doc
      } : {})
    };
  }

}; // Schema

exports.Def = Def;

function isReservedKey(key) {
  return key === '_doc' || key === "_";
}

// Parser
function parseTypeDef(def) {
  const parser = new SchemaParser();
  return parser.parseTypeDef(def, '');
} // Internals


function combineName(base, name) {
  return base !== '' ? `${base}.${name}` : name;
}

const UnresolvedType = {
  void: {},
  doc: ''
};

class SchemaParser {
  constructor() {
    this.types = {};
  }

  typeRef(def) {
    const defRef = def._ref || '';
    const existing = this.types[defRef];

    if (existing) {
      if (existing.type !== UnresolvedType) {
        return {
          ref: {
            name: defRef,
            type: existing.type
          }
        };
      }

      const ref = {
        name: defRef,
        type: UnresolvedType
      };
      existing.unresolved.push(ref);
      return {
        ref
      };
    }

    const ref = {
      name: defRef,
      type: UnresolvedType
    };
    this.types[defRef] = {
      type: UnresolvedType,
      unresolved: [ref]
    };
    return {
      ref
    };
  }

  resolveType(name, type) {
    const existing = this.types[name];

    if (existing) {
      existing.unresolved.forEach(x => x.type = type);
    }

    this.types[name] = {
      type,
      unresolved: []
    };
  }

  namedMembersFromUnorderedDefs(defs, mapMember) {
    return Object.keys(defs).map(memberName => {
      const memberDef = defs[memberName];
      return {
        name: memberName,
        ...mapMember(memberName, memberDef)
      };
    });
  }

  namedMembersFromOrderedDefs(defs, mapMember) {
    const members = [];
    defs.forEach(unorderedDefs => {
      this.namedMembersFromUnorderedDefs(unorderedDefs, mapMember).forEach(member => {
        members.push(member);
      });
    });
    return members;
  }

  namedMembers(defs, mapMember) {
    return Array.isArray(defs) ? this.namedMembersFromOrderedDefs(defs, mapMember) : this.namedMembersFromUnorderedDefs(defs, mapMember);
  }

  typedNamedMembers(memberDefs, name) {
    return this.namedMembers(memberDefs, (memberName, memberDef) => {
      return this.parseTypeDef(memberDef, combineName(name, memberName));
    });
  }

  typedNamedOrderedMembers(memberDefs, name) {
    return this.namedMembersFromOrderedDefs(memberDefs, (memberName, memberDef) => {
      return this.parseTypeDef(memberDef, combineName(name, memberName));
    });
  }

  parseTypeDef(def, name) {
    const scalarTypes = ['_void', '_any', '_int', '_float', '_string', '_bool', '_time'];

    if (!def) {
      console.log('>>>', name, def);
    }

    let type = {
      def,
      doc: def._doc || '',
      _: def._ || {}
    };
    const scalarType = scalarTypes.find(t => t in def);

    if (scalarType) {
      Object.assign(type, def);
      type[scalarType.substr(1)] = def[scalarType];
    } else if (def._ref) {
      Object.assign(type, this.typeRef(def));
    } else if (def._array) {
      type.array = this.parseTypeDef(def._array, combineName(name, 'item'));
    } else if (def._struct) {
      type.struct = this.typedNamedMembers(def._struct, name);
    } else if (def._union) {
      type.union = this.namedMembers(def._union, (memberName, memberDef) => {
        return memberDef._value ? memberDef : this.parseTypeDef(memberDef, combineName(name, memberName));
      });
    } else if (def._class) {
      const classDef = def._class;
      type.class = {
        types: classDef.types ? this.typedNamedMembers(classDef.types, name) : [],
        fields: classDef.fields ? this.typedNamedMembers(classDef.fields, name) : [],
        functions: classDef.functions ? this.namedMembers(classDef.functions, (functionName, functionDef) => {
          return {
            def: functionDef,
            doc: functionDef._doc || '',
            args: functionDef.args ? this.typedNamedOrderedMembers(functionDef.args, combineName(name, functionName)) : [],
            result: functionDef.result ? this.parseTypeDef(functionDef.result, combineName(name, 'Result')) : {
              doc: '',
              void: {}
            }
          };
        }) : []
      };
    } else if (Array.isArray(def)) {
      type.struct = this.typedNamedMembers(def, name);
    } else if (typeof def === 'object') {
      const filteredDef = {};
      Object.keys(def).forEach(key => {
        if (!isReservedKey(key)) {
          filteredDef[key] = def[key];
        }
      });
      type.struct = this.typedNamedMembers(filteredDef, name);
    } else {
      console.log('>>>', name);
    }

    this.resolveType(name, type);
    return type;
  }

}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NlcnZlci9zY2hlbWEvc2NoZW1hLmpzIl0sIm5hbWVzIjpbIkRlZiIsInZvaWRfIiwiZG9jIiwiX3ZvaWQiLCJfZG9jIiwiYW55IiwiX2FueSIsImludCIsIl9pbnQiLCJmbG9hdCIsIl9mbG9hdCIsInN0cmluZyIsIl9zdHJpbmciLCJib29sIiwiX2Jvb2wiLCJ0aW1lIiwiX3RpbWUiLCJhcnJheU9mIiwiaXRlbSIsIl9hcnJheSIsInVuaW9uT2YiLCJtZW1iZXJzIiwiX3VuaW9uIiwicmVmIiwibmFtZU9yVHlwZSIsIm5hbWUiLCJPYmplY3QiLCJrZXlzIiwiX3JlZiIsInZhbHVlIiwiX3ZhbHVlIiwiaXNSZXNlcnZlZEtleSIsImtleSIsInBhcnNlVHlwZURlZiIsImRlZiIsInBhcnNlciIsIlNjaGVtYVBhcnNlciIsImNvbWJpbmVOYW1lIiwiYmFzZSIsIlVucmVzb2x2ZWRUeXBlIiwidm9pZCIsImNvbnN0cnVjdG9yIiwidHlwZXMiLCJ0eXBlUmVmIiwiZGVmUmVmIiwiZXhpc3RpbmciLCJ0eXBlIiwidW5yZXNvbHZlZCIsInB1c2giLCJyZXNvbHZlVHlwZSIsImZvckVhY2giLCJ4IiwibmFtZWRNZW1iZXJzRnJvbVVub3JkZXJlZERlZnMiLCJkZWZzIiwibWFwTWVtYmVyIiwibWFwIiwibWVtYmVyTmFtZSIsIm1lbWJlckRlZiIsIm5hbWVkTWVtYmVyc0Zyb21PcmRlcmVkRGVmcyIsInVub3JkZXJlZERlZnMiLCJtZW1iZXIiLCJuYW1lZE1lbWJlcnMiLCJBcnJheSIsImlzQXJyYXkiLCJ0eXBlZE5hbWVkTWVtYmVycyIsIm1lbWJlckRlZnMiLCJ0eXBlZE5hbWVkT3JkZXJlZE1lbWJlcnMiLCJzY2FsYXJUeXBlcyIsImNvbnNvbGUiLCJsb2ciLCJfIiwic2NhbGFyVHlwZSIsImZpbmQiLCJ0IiwiYXNzaWduIiwic3Vic3RyIiwiYXJyYXkiLCJfc3RydWN0Iiwic3RydWN0IiwidW5pb24iLCJfY2xhc3MiLCJjbGFzc0RlZiIsImNsYXNzIiwiZmllbGRzIiwiZnVuY3Rpb25zIiwiZnVuY3Rpb25OYW1lIiwiZnVuY3Rpb25EZWYiLCJhcmdzIiwicmVzdWx0IiwiZmlsdGVyZWREZWYiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7QUFHQTtBQTJDTyxNQUFNQSxHQUFHLEdBQUc7QUFDZkMsRUFBQUEsS0FBSyxDQUFDQyxHQUFELEVBQStCO0FBQ2hDLFdBQU87QUFBRUMsTUFBQUEsS0FBSyxFQUFFLEVBQVQ7QUFBYSxVQUFJRCxHQUFHLEdBQUc7QUFBRUUsUUFBQUEsSUFBSSxFQUFFRjtBQUFSLE9BQUgsR0FBbUIsRUFBMUI7QUFBYixLQUFQO0FBQ0gsR0FIYzs7QUFJZkcsRUFBQUEsR0FBRyxDQUFDSCxHQUFELEVBQStCO0FBQzlCLFdBQU87QUFBRUksTUFBQUEsSUFBSSxFQUFFLEVBQVI7QUFBWSxVQUFJSixHQUFHLEdBQUc7QUFBRUUsUUFBQUEsSUFBSSxFQUFFRjtBQUFSLE9BQUgsR0FBbUIsRUFBMUI7QUFBWixLQUFQO0FBQ0gsR0FOYzs7QUFPZkssRUFBQUEsR0FBRyxDQUFDTCxHQUFELEVBQStCO0FBQzlCLFdBQU87QUFBRU0sTUFBQUEsSUFBSSxFQUFFLEVBQVI7QUFBWSxVQUFJTixHQUFHLEdBQUc7QUFBRUUsUUFBQUEsSUFBSSxFQUFFRjtBQUFSLE9BQUgsR0FBbUIsRUFBMUI7QUFBWixLQUFQO0FBQ0gsR0FUYzs7QUFVZk8sRUFBQUEsS0FBSyxDQUFDUCxHQUFELEVBQStCO0FBQ2hDLFdBQU87QUFBRVEsTUFBQUEsTUFBTSxFQUFFLEVBQVY7QUFBYyxVQUFJUixHQUFHLEdBQUc7QUFBRUUsUUFBQUEsSUFBSSxFQUFFRjtBQUFSLE9BQUgsR0FBbUIsRUFBMUI7QUFBZCxLQUFQO0FBQ0gsR0FaYzs7QUFhZlMsRUFBQUEsTUFBTSxDQUFDVCxHQUFELEVBQStCO0FBQ2pDLFdBQU87QUFBRVUsTUFBQUEsT0FBTyxFQUFFLEVBQVg7QUFBZSxVQUFJVixHQUFHLEdBQUc7QUFBRUUsUUFBQUEsSUFBSSxFQUFFRjtBQUFSLE9BQUgs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QUssQ0FBQ0MsT0FBTixDQUFjN0IsR0FBZCxDQUFKLEVBQXdCO0FBQzNCWSxNQUFBQSxJQUFJLENBQUNnQyxNQUFMLEdBQWMsS0FBS2QsaUJBQUwsQ0FBd0I5QixHQUF4QixFQUFtQ1QsSUFBbkMsQ0FBZDtBQUNILEtBRk0sTUFFQSxJQUFJLE9BQU9TLEdBQVAsS0FBZSxRQUFuQixFQUE2QjtBQUNoQyxZQUFNdUQsV0FBVyxHQUFHLEVBQXBCO0FBQ0EvRCxNQUFBQSxNQUFNLENBQUNDLElBQVAsQ0FBWU8sR0FBWixFQUFpQmdCLE9BQWpCLENBQTBCbEIsR0FBRCxJQUFTO0FBQzlCLFlBQUksQ0FBQ0QsYUFBYSxDQUFDQyxHQUFELENBQWxCLEVBQXlCO0FBQ3JCeUQsVUFBQUEsV0FBVyxDQUFDekQsR0FBRCxDQUFYLEdBQW1CRSxHQUFHLENBQUNGLEdBQUQsQ0FBdEI7QUFDSDtBQUNKLE9BSkQ7QUFLQWMsTUFBQUEsSUFBSSxDQUFDZ0MsTUFBTCxHQUFjLEtBQUtkLGlCQUFMLENBQXdCeUIsV0FBeEIsRUFBMkNoRSxJQUEzQyxDQUFkO0FBQ0gsS0FSTSxNQVFBO0FBQ0gyQyxNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBWSxLQUFaLEVBQW1CNUMsSUFBbkI7QUFDSDs7QUFDRCxTQUFLd0IsV0FBTCxDQUFpQnhCLElBQWpCLEVBQXVCcUIsSUFBdkI7QUFDQSxXQUFPQSxJQUFQO0FBQ0g7O0FBMUljIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgbm8tdXNlLWJlZm9yZS1kZWZpbmUgKi9cbi8vIEBmbG93XG5cbi8vIERlZlxuXG5leHBvcnQgdHlwZSBEb2NDb250ZW50RGVmID0gc3RyaW5nIHwgeyBtZDogc3RyaW5nIH0gfCB7IGh0bWw6IHN0cmluZyB9O1xuXG5leHBvcnQgdHlwZSBEb2NEZWYgPSB7IF9kb2M/OiBEb2NDb250ZW50RGVmIH1cblxuZXhwb3J0IHR5cGUgQ2xhc3NEZWYgPSB7XG4gICAgdHlwZXM/OiBNZW1iZXJzRGVmPFR5cGVEZWY+LFxuICAgIGZpZWxkcz86IE1lbWJlcnNEZWY8VHlwZURlZj4sXG4gICAgZnVuY3Rpb25zPzogTWVtYmVyc0RlZjxGdW5jdGlvbkRlZj5cbn1cblxuZXhwb3J0IHR5cGUgSW50U2l6ZVR5cGUgPSA4IHwgMTYgfCAzMiB8IDY0IHwgMTI4IHwgMjU2O1xuXG5leHBvcnQgdHlwZSBUeXBlRGVmID0gRG9jRGVmICYge1xuICAgIF92b2lkPzoge30sXG4gICAgX2FueT86IHt9LFxuICAgIF9yZWY/OiBzdHJpbmcsXG4gICAgX2Jvb2w/OiB7fSxcbiAgICBfdGltZT86IHt9LFxuICAgIF9zdHJpbmc/OiB7fSxcbiAgICBfZmxvYXQ/OiB7IHNpemU/OiAzMiB8IDY0IH0sXG4gICAgX2ludD86IHsgdW5zaWduZWQ/OiBib29sZWFuLCBzaXplPzogSW50U2l6ZVR5cGUgfSxcbiAgICBfYXJyYXk/OiBUeXBlRGVmLFxuICAgIF9zdHJ1Y3Q/OiBNZW1iZXJzRGVmPFR5cGVEZWY+LFxuICAgIF91bmlvbj86IE1lbWJlcnNEZWY8VHlwZURlZj4sXG4gICAgX2NsYXNzPzogQ2xhc3NEZWYsXG4gICAgX3ZhbHVlPzogc3RyaW5nIHwgbnVtYmVyIHwgYm9vbGVhbixcbn1cblxuZXhwb3J0IHR5cGUgRnVuY3Rpb25EZWYgPSBEb2NEZWYgJiB7XG4gICAgYXJncz86IE9yZGVyZWRNZW1iZXJzRGVmPFR5cGVEZWY+LFxuICAgIHJlc3VsdD86IFR5cGVEZWYsXG59XG5cbmV4cG9ydCB0eXBlIFVub3JkZXJlZE1lbWJlcnNEZWY8TT4gPSB7XG4gICAgW3N0cmluZ106IE1cbn1cblxuZXhwb3J0IHR5cGUgT3JkZXJlZE1lbWJlcnNEZWY8TT4gPSBVbm9yZGVyZWRNZW1iZXJzRGVmPE0+W11cblxuZXhwb3J0IHR5cGUgTWVtYmVyc0RlZjxNPiA9IE9yZGVyZWRNZW1iZXJzRGVmPE0+IHwgVW5vcmRlcmVkTWVtYmVyc0RlZjxNPlxuXG5leHBvcnQgY29uc3QgRGVmID0ge1xuICAgIHZvaWRfKGRvYz86IERvY0NvbnRlbnREZWYpOiBUeXBlRGVmIHtcbiAgICAgICAgcmV0dXJuIHsgX3ZvaWQ6IHt9LCAuLi4oZG9jID8geyBfZG9jOiBkb2MgfSA6IHt9KSB9XG4gICAgfSxcbiAgICBhbnkoZG9jPzogRG9jQ29udGVudERlZik6IFR5cGVEZWYge1xuICAgICAgICByZXR1cm4geyBfYW55OiB7fSwgLi4uKGRvYyA/IHsgX2RvYzogZG9jIH0gOiB7fSkgfVxuICAgIH0sXG4gICAgaW50KGRvYz86IERvY0NvbnRlbnREZWYpOiBUeXBlRGVmIHtcbiAgICAgICAgcmV0dXJuIHsgX2ludDoge30sIC4uLihkb2MgPyB7IF9kb2M6IGRvYyB9IDoge30pIH1cbiAgICB9LFxuICAgIGZsb2F0KGRvYz86IERvY0NvbnRlbnREZWYpOiBUeXBlRGVmIHtcbiAgICAgICAgcmV0dXJuIHsgX2Zsb2F0OiB7fSwgLi4uKGRvYyA/IHsgX2RvYzogZG9jIH0gOiB7fSkgfVxuICAgIH0sXG4gICAgc3RyaW5nKGRvYz86IERvY0NvbnRlbnREZWYpOiBUeXBlRGVmIHtcbiAgICAgICAgcmV0dXJuIHsgX3N0cmluZzoge30sIC4uLihkb2MgPyB7IF9kb2M6IGRvYyB9IDoge30pIH1cbiAgICB9LFxuICAgIGJvb2woZG9jPzogRG9jQ29udGVudERlZik6IFR5cGVEZWYge1xuICAgICAgICByZXR1cm4geyBfYm9vbDoge30sIC4uLihkb2MgPyB7IF9kb2M6IGRvYyB9IDoge30pIH1cbiAgICB9LFxuICAgIHRpbWUoZG9jPzogRG9jQ29udGVudERlZik6IFR5cGVEZWYge1xuICAgICAgICByZXR1cm4geyBfdGltZToge30sIC4uLihkb2MgPyB7IF9kb2M6IGRvYyB9IDoge30pIH1cbiAgICB9LFxuICAgIGFycmF5T2YoaXRlbTogVHlwZURlZiwgZG9jPzogRG9jQ29udGVudERlZik6IFR5cGVEZWYge1xuICAgICAgICByZXR1cm4geyBfYXJyYXk6IGl0ZW0sIC4uLihkb2MgPyB7IF9kb2M6IGRvYyB9IDoge30pIH1cbiAgICB9LFxuICAgIHVuaW9uT2YobWVtYmVyczogTWVtYmVyc0RlZjxUeXBlRGVmPiwgZG9jPzogRG9jQ29udGVudERlZik6IFR5cGVEZWYge1xuICAgICAgICByZXR1cm4geyBfdW5pb246IG1lbWJlcnMsIC4uLihkb2MgPyB7IF9kb2M6IGRvYyB9IDoge30pIH1cbiAgICB9LFxuICAgIHJlZihuYW1lT3JUeXBlOiBzdHJpbmcgfCB7IFtzdHJpbmddOiBUeXBlRGVmIH0sIGRvYz86IERvY0NvbnRlbnREZWYpOiBUeXBlRGVmIHtcbiAgICAgICAgY29uc3QgbmFtZSA9IHR5cGVvZiBuYW1lT3JUeXBlID09PSAnc3RyaW5nJyA/IG5hbWVPclR5cGUgOiBPYmplY3Qua2V5cyhuYW1lT3JUeXBlKVswXTtcbiAgICAgICAgcmV0dXJuIHsgX3JlZjogbmFtZSwgLi4uKGRvYyA/IHsgX2RvYzogZG9jIH0gOiB7fSkgfTtcbiAgICB9LFxuICAgIHZhbHVlKHZhbHVlOiBzdHJpbmcsIGRvYz86IERvY0NvbnRlbnREZWYpOiBUeXBlRGVmIHtcbiAgICAgICAgcmV0dXJuIHsgX3ZhbHVlOiB2YWx1ZSwgLi4uKGRvYyA/IHsgX2RvYzogZG9jIH0gOiB7fSkgfVxuICAgIH0sXG59O1xuXG4vLyBTY2hlbWFcbmZ1bmN0aW9uIGlzUmVzZXJ2ZWRLZXkoa2V5OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICByZXR1cm4ga2V5ID09PSAnX2RvYycgfHwga2V5ID09PSBcIl9cIjtcbn1cblxuZXhwb3J0IHR5cGUgU2NoZW1hRG9jID0ge1xuICAgIGRvYz86IChzdHJpbmcgfCB7IG1kOiBzdHJpbmcgfSB8IHsgaHRtbDogc3RyaW5nIH0pXG59XG5cbmV4cG9ydCB0eXBlIFNjaGVtYUNsYXNzID0ge1xuICAgIHR5cGVzOiBTY2hlbWFNZW1iZXI8U2NoZW1hVHlwZT5bXSxcbiAgICBmaWVsZHM6IFNjaGVtYU1lbWJlcjxTY2hlbWFUeXBlPltdLFxuICAgIGZ1bmN0aW9uczogU2NoZW1hTWVtYmVyPFNjaGVtYUZ1bmN0aW9uPltdXG59XG5cbmV4cG9ydCB0eXBlIFNjaGVtYVR5cGUgPSBTY2hlbWFEb2MgJiB7XG4gICAgdm9pZD86IHt9LFxuICAgIGFueT86IHt9LFxuICAgIGludD86IHsgdW5zaWduZWQ/OiBib29sZWFuLCBzaXplPzogSW50U2l6ZVR5cGUgfSxcbiAgICBmbG9hdD86IHsgc2l6ZT86ICgzMiB8IDY0KSB9LFxuICAgIHN0cmluZz86IHt9LFxuICAgIGJvb2w/OiB7fSxcbiAgICB0aW1lPzoge30sXG4gICAgYXJyYXk/OiBTY2hlbWFUeXBlLFxuICAgIHN0cnVjdD86IFNjaGVtYU1lbWJlcjxTY2hlbWFUeXBlPltdLFxuICAgIHVuaW9uPzogU2NoZW1hTWVtYmVyPFNjaGVtYVR5cGU+W10sXG4gICAgcmVmPzogeyBuYW1lOiBzdHJpbmcsIHR5cGU6IFNjaGVtYVR5cGUgfSxcbiAgICBjbGFzcz86IFNjaGVtYUNsYXNzLFxuICAgIHZhbHVlPzogc3RyaW5nIHwgbnVtYmVyIHwgYm9vbGVhblxufVxuXG5leHBvcnQgdHlwZSBTY2hlbWFGdW5jdGlvbiA9IFNjaGVtYURvYyAmIHtcbiAgICBhcmdzOiBTY2hlbWFNZW1iZXI8U2NoZW1hVHlwZT5bXSxcbiAgICByZXN1bHQ6IFNjaGVtYVR5cGUsXG59XG5cbmV4cG9ydCB0eXBlIFNjaGVtYU1lbWJlcjxNPiA9IHsgbmFtZTogc3RyaW5nIH0gJiBNXG5cbi8vIFBhcnNlclxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VUeXBlRGVmKGRlZjogVHlwZURlZik6IFNjaGVtYVR5cGUge1xuICAgIGNvbnN0IHBhcnNlciA9IG5ldyBTY2hlbWFQYXJzZXIoKTtcbiAgICByZXR1cm4gcGFyc2VyLnBhcnNlVHlwZURlZihkZWYsICcnKTtcbn1cblxuLy8gSW50ZXJuYWxzXG5cbnR5cGUgUGFyc2luZ1R5cGUgPSB7XG4gICAgdHlwZTogU2NoZW1hVHlwZSxcbiAgICB1bnJlc29sdmVkOiB7IG5hbWU6IHN0cmluZywgdHlwZTogU2NoZW1hVHlwZSB9W10sXG59XG5cbmZ1bmN0aW9uIGNvbWJpbmVOYW1lKGJhc2U6IHN0cmluZywgbmFtZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYmFzZSAhPT0gJycgPyBgJHtiYXNlfS4ke25hbWV9YCA6IG5hbWU7XG59XG5cbmNvbnN0IFVucmVzb2x2ZWRUeXBlOiBTY2hlbWFUeXBlID0ge1xuICAgIHZvaWQ6IHt9LFxuICAgIGRvYzogJycsXG59O1xuXG5jbGFzcyBTY2hlbWFQYXJzZXIge1xuICAgIHR5cGVzOiB7IFtzdHJpbmddOiBQYXJzaW5nVHlwZSB9O1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMudHlwZXMgPSB7fTtcbiAgICB9XG5cbiAgICB0eXBlUmVmKGRlZjogVHlwZURlZik6IFNjaGVtYVR5cGUge1xuICAgICAgICBjb25zdCBkZWZSZWYgPSBkZWYuX3JlZiB8fCAnJztcbiAgICAgICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLnR5cGVzW2RlZlJlZl07XG4gICAgICAgIGlmIChleGlzdGluZykge1xuICAgICAgICAgICAgaWYgKGV4aXN0aW5nLnR5cGUgIT09IFVucmVzb2x2ZWRUeXBlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgcmVmOiB7IG5hbWU6IGRlZlJlZiwgdHlwZTogZXhpc3RpbmcudHlwZSB9IH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHJlZiA9IHsgbmFtZTogZGVmUmVmLCB0eXBlOiBVbnJlc29sdmVkVHlwZSB9O1xuICAgICAgICAgICAgZXhpc3RpbmcudW5yZXNvbHZlZC5wdXNoKHJlZik7XG4gICAgICAgICAgICByZXR1cm4geyByZWYgfTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCByZWYgPSB7IG5hbWU6IGRlZlJlZiwgdHlwZTogVW5yZXNvbHZlZFR5cGUgfTtcbiAgICAgICAgdGhpcy50eXBlc1tkZWZSZWZdID0geyB0eXBlOiBVbnJlc29sdmVkVHlwZSwgdW5yZXNvbHZlZDogW3JlZl0gfTtcbiAgICAgICAgcmV0dXJuIHsgcmVmIH07XG4gICAgfVxuXG4gICAgcmVzb2x2ZVR5cGUobmFtZTogc3RyaW5nLCB0eXBlOiBTY2hlbWFUeXBlKSB7XG4gICAgICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy50eXBlc1tuYW1lXTtcbiAgICAgICAgaWYgKGV4aXN0aW5nKSB7XG4gICAgICAgICAgICBleGlzdGluZy51bnJlc29sdmVkLmZvckVhY2goeCA9PiB4LnR5cGUgPSB0eXBlKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnR5cGVzW25hbWVdID0geyB0eXBlLCB1bnJlc29sdmVkOiBbXSB9O1xuICAgIH1cblxuICAgIG5hbWVkTWVtYmVyc0Zyb21Vbm9yZGVyZWREZWZzPEQsIFM+KFxuICAgICAgICBkZWZzOiBVbm9yZGVyZWRNZW1iZXJzRGVmPEQ+LFxuICAgICAgICBtYXBNZW1iZXI6IChtZW1iZXJOYW1lOiBzdHJpbmcsIG1lbWJlckRlZjogRCkgPT4gU1xuICAgICk6IFNjaGVtYU1lbWJlcjxTPltdIHtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKGRlZnMpLm1hcDxTY2hlbWFNZW1iZXI8Uz4+KChtZW1iZXJOYW1lOiBzdHJpbmcpOiBTY2hlbWFNZW1iZXI8Uz4gPT4ge1xuICAgICAgICAgICAgY29uc3QgbWVtYmVyRGVmID0gZGVmc1ttZW1iZXJOYW1lXTtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgbmFtZTogbWVtYmVyTmFtZSxcbiAgICAgICAgICAgICAgICAuLi5tYXBNZW1iZXIobWVtYmVyTmFtZSwgbWVtYmVyRGVmKVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgbmFtZWRNZW1iZXJzRnJvbU9yZGVyZWREZWZzPEQsIFM+KFxuICAgICAgICBkZWZzOiBPcmRlcmVkTWVtYmVyc0RlZjxEPixcbiAgICAgICAgbWFwTWVtYmVyOiAobmFtZTogc3RyaW5nLCBkZWY6IEQpID0+IFNcbiAgICApOiBTY2hlbWFNZW1iZXI8Uz5bXSB7XG4gICAgICAgIGNvbnN0IG1lbWJlcnM6IFNjaGVtYU1lbWJlcjxTPltdID0gW107XG4gICAgICAgIGRlZnMuZm9yRWFjaCgodW5vcmRlcmVkRGVmczogVW5vcmRlcmVkTWVtYmVyc0RlZjxEPikgPT4ge1xuICAgICAgICAgICAgdGhpcy5uYW1lZE1lbWJlcnNGcm9tVW5vcmRlcmVkRGVmcyh1bm9yZGVyZWREZWZzLCBtYXBNZW1iZXIpLmZvckVhY2goKG1lbWJlcjogU2NoZW1hTWVtYmVyPFM+KSA9PiB7XG4gICAgICAgICAgICAgICAgbWVtYmVycy5wdXNoKG1lbWJlcilcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gbWVtYmVycztcbiAgICB9XG5cbiAgICBuYW1lZE1lbWJlcnM8RCwgUz4oXG4gICAgICAgIGRlZnM6IE1lbWJlcnNEZWY8RD4sXG4gICAgICAgIG1hcE1lbWJlcjogKG5hbWU6IHN0cmluZywgZGVmOiBEKSA9PiBTXG4gICAgKTogU2NoZW1hTWVtYmVyPFM+W10ge1xuICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShkZWZzKVxuICAgICAgICAgICAgPyB0aGlzLm5hbWVkTWVtYmVyc0Zyb21PcmRlcmVkRGVmcyhkZWZzLCBtYXBNZW1iZXIpXG4gICAgICAgICAgICA6IHRoaXMubmFtZWRNZW1iZXJzRnJvbVVub3JkZXJlZERlZnMoZGVmcywgbWFwTWVtYmVyKTtcbiAgICB9XG5cbiAgICB0eXBlZE5hbWVkTWVtYmVyczxEOiBUeXBlRGVmPihtZW1iZXJEZWZzOiBNZW1iZXJzRGVmPEQ+LCBuYW1lOiBzdHJpbmcpOiBTY2hlbWFNZW1iZXI8U2NoZW1hVHlwZT5bXSB7XG4gICAgICAgIHJldHVybiB0aGlzLm5hbWVkTWVtYmVyczxELCBTY2hlbWFUeXBlPihtZW1iZXJEZWZzLCAobWVtYmVyTmFtZTogc3RyaW5nLCBtZW1iZXJEZWY6IEQpOiBTY2hlbWFUeXBlID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcnNlVHlwZURlZihtZW1iZXJEZWYsIGNvbWJpbmVOYW1lKG5hbWUsIG1lbWJlck5hbWUpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgdHlwZWROYW1lZE9yZGVyZWRNZW1iZXJzPEQ6IFR5cGVEZWY+KG1lbWJlckRlZnM6IE9yZGVyZWRNZW1iZXJzRGVmPEQ+LCBuYW1lOiBzdHJpbmcpOiBTY2hlbWFNZW1iZXI8U2NoZW1hVHlwZT5bXSB7XG4gICAgICAgIHJldHVybiB0aGlzLm5hbWVkTWVtYmVyc0Zyb21PcmRlcmVkRGVmczxELCBTY2hlbWFUeXBlPihtZW1iZXJEZWZzLCAobWVtYmVyTmFtZTogc3RyaW5nLCBtZW1iZXJEZWY6IEQpOiBTY2hlbWFUeXBlID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcnNlVHlwZURlZihtZW1iZXJEZWYsIGNvbWJpbmVOYW1lKG5hbWUsIG1lbWJlck5hbWUpKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG5cbiAgICBwYXJzZVR5cGVEZWYoZGVmOiBUeXBlRGVmLCBuYW1lOiBzdHJpbmcpOiBTY2hlbWFUeXBlIHtcbiAgICAgICAgY29uc3Qgc2NhbGFyVHlwZXMgPSBbJ192b2lkJywgJ19hbnknLCAnX2ludCcsICdfZmxvYXQnLCAnX3N0cmluZycsICdfYm9vbCcsICdfdGltZSddO1xuICAgICAgICBpZiAoIWRlZikge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJz4+PicsIG5hbWUsIGRlZik7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHR5cGU6IGFueSA9IHtcbiAgICAgICAgICAgIGRlZixcbiAgICAgICAgICAgIGRvYzogZGVmLl9kb2MgfHwgJycsXG4gICAgICAgICAgICBfOiBkZWYuXyB8fCB7fSxcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3Qgc2NhbGFyVHlwZSA9IHNjYWxhclR5cGVzLmZpbmQodCA9PiB0IGluIGRlZik7XG4gICAgICAgIGlmIChzY2FsYXJUeXBlKSB7XG4gICAgICAgICAgICBPYmplY3QuYXNzaWduKHR5cGUsIGRlZik7XG4gICAgICAgICAgICB0eXBlW3NjYWxhclR5cGUuc3Vic3RyKDEpXSA9IGRlZltzY2FsYXJUeXBlXTtcbiAgICAgICAgfSBlbHNlIGlmIChkZWYuX3JlZikge1xuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbih0eXBlLCB0aGlzLnR5cGVSZWYoKGRlZjogYW55KSkpO1xuICAgICAgICB9IGVsc2UgaWYgKGRlZi5fYXJyYXkpIHtcbiAgICAgICAgICAgIHR5cGUuYXJyYXkgPSB0aGlzLnBhcnNlVHlwZURlZihkZWYuX2FycmF5LCBjb21iaW5lTmFtZShuYW1lLCAnaXRlbScpKTtcbiAgICAgICAgfSBlbHNlIGlmIChkZWYuX3N0cnVjdCkge1xuICAgICAgICAgICAgdHlwZS5zdHJ1Y3QgPSB0aGlzLnR5cGVkTmFtZWRNZW1iZXJzKGRlZi5fc3RydWN0LCBuYW1lKTtcbiAgICAgICAgfSBlbHNlIGlmIChkZWYuX3VuaW9uKSB7XG4gICAgICAgICAgICB0eXBlLnVuaW9uID0gdGhpcy5uYW1lZE1lbWJlcnMoZGVmLl91bmlvbiwgKG1lbWJlck5hbWUsIG1lbWJlckRlZikgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBtZW1iZXJEZWYuX3ZhbHVlXG4gICAgICAgICAgICAgICAgICAgID8gbWVtYmVyRGVmXG4gICAgICAgICAgICAgICAgICAgIDogdGhpcy5wYXJzZVR5cGVEZWYobWVtYmVyRGVmLCBjb21iaW5lTmFtZShuYW1lLCBtZW1iZXJOYW1lKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIGlmIChkZWYuX2NsYXNzKSB7XG4gICAgICAgICAgICBjb25zdCBjbGFzc0RlZiA9IGRlZi5fY2xhc3M7XG4gICAgICAgICAgICB0eXBlLmNsYXNzID0ge1xuICAgICAgICAgICAgICAgIHR5cGVzOiBjbGFzc0RlZi50eXBlcyA/IHRoaXMudHlwZWROYW1lZE1lbWJlcnMoY2xhc3NEZWYudHlwZXMsIG5hbWUpIDogW10sXG4gICAgICAgICAgICAgICAgZmllbGRzOiBjbGFzc0RlZi5maWVsZHMgPyB0aGlzLnR5cGVkTmFtZWRNZW1iZXJzKGNsYXNzRGVmLmZpZWxkcywgbmFtZSkgOiBbXSxcbiAgICAgICAgICAgICAgICBmdW5jdGlvbnM6IGNsYXNzRGVmLmZ1bmN0aW9ucyA/IHRoaXMubmFtZWRNZW1iZXJzKGNsYXNzRGVmLmZ1bmN0aW9ucywgKGZ1bmN0aW9uTmFtZSwgZnVuY3Rpb25EZWY6IEZ1bmN0aW9uRGVmKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBkZWY6IGZ1bmN0aW9uRGVmLFxuICAgICAgICAgICAgICAgICAgICAgICAgZG9jOiBmdW5jdGlvbkRlZi5fZG9jIHx8ICcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgYXJnczogZnVuY3Rpb25EZWYuYXJnc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gdGhpcy50eXBlZE5hbWVkT3JkZXJlZE1lbWJlcnMoZnVuY3Rpb25EZWYuYXJncywgY29tYmluZU5hbWUobmFtZSwgZnVuY3Rpb25OYW1lKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IFtdLFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiBmdW5jdGlvbkRlZi5yZXN1bHRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IHRoaXMucGFyc2VUeXBlRGVmKGZ1bmN0aW9uRGVmLnJlc3VsdCwgY29tYmluZU5hbWUobmFtZSwgJ1Jlc3VsdCcpKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogeyBkb2M6ICcnLCB2b2lkOiB7fSB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KSA6IFtdLFxuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoZGVmKSkge1xuICAgICAgICAgICAgdHlwZS5zdHJ1Y3QgPSB0aGlzLnR5cGVkTmFtZWRNZW1iZXJzKChkZWY6IGFueSksIG5hbWUpO1xuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBkZWYgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICBjb25zdCBmaWx0ZXJlZERlZiA9IHt9O1xuICAgICAgICAgICAgT2JqZWN0LmtleXMoZGVmKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIWlzUmVzZXJ2ZWRLZXkoa2V5KSkge1xuICAgICAgICAgICAgICAgICAgICBmaWx0ZXJlZERlZltrZXldID0gZGVmW2tleV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0eXBlLnN0cnVjdCA9IHRoaXMudHlwZWROYW1lZE1lbWJlcnMoKGZpbHRlcmVkRGVmOiBhbnkpLCBuYW1lKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCc+Pj4nLCBuYW1lKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnJlc29sdmVUeXBlKG5hbWUsIHR5cGUpO1xuICAgICAgICByZXR1cm4gdHlwZTtcbiAgICB9XG59XG5cbiJdfQ==