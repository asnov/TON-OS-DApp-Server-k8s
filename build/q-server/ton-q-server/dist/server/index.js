"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.main = main;

var _config = require("./config");

var _server = _interopRequireDefault(require("./server"));

var _logs = _interopRequireDefault(require("./logs"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/*
 * Copyright 2018-2020 TON DEV SOLUTIONS LTD.
 *
 * Licensed under the SOFTWARE EVALUATION License (the "License"); you may not use
 * this file except in compliance with the License.  You may obtain a copy of the
 * License at:
 *
 * http://www.ton.dev/licenses
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific TON DEV software governing permissions and
 * limitations under the License.
 */
const program = require('commander');

const commandLineDefaults = (0, _config.resolveOptions)({}, process.env, _config.defaultOptions);
program.option('-h, --host <host>', 'listening address', commandLineDefaults.host).option('-p, --port <port>', 'listening port', commandLineDefaults.port).option('--rpc-port <port>', 'listening rpc port', commandLineDefaults.rpcPort).option('-m, --requests-mode <mode>', 'Requests mode (kafka | rest)', commandLineDefaults.requestsMode).option('-r, --requests-server <url>', 'Requests server url', commandLineDefaults.requestsServer).option('-t, --requests-topic <name>', 'Requests topic name', commandLineDefaults.requestsTopic).option('-d, --db-server <address>', 'database server:port', commandLineDefaults.dbServer).option('-n, --db-name <name>', 'database name', commandLineDefaults.dbName).option('-a, --db-auth <name>', 'database auth in form "user:password', commandLineDefaults.dbAuth).option('--db-max-sockets <number>', 'database max sockets', commandLineDefaults.dbMaxSockets).option('--slow-db-server <address>', 'slow queries database server:port', commandLineDefaults.slowDbServer).option('--slow-db-name <name>', 'slow database name', commandLineDefaults.slowDbName).option('--slow-db-auth <name>', 'slow database auth in form "user:password', commandLineDefaults.slowDbAuth).option('--slow-db-max-sockets <number>', 'slow database max sockets', commandLineDefaults.slowDbMaxSockets).option('--auth-endpoint <url>', 'auth endpoint', commandLineDefaults.authEndpoint).option('--mam-access-keys <keys>', 'Access keys used to authorize mam endpoint access', commandLineDefaults.mamAccessKeys).option('-j, --jaeger-endpoint <url>', 'jaeger endpoint', commandLineDefaults.jaegerEndpoint).option('--trace-service <name>', 'trace service name', commandLineDefaults.traceService).option('--trace-tags <tags>', 'additional trace tags (comma separated name=value pairs)', commandLineDefaults.traceTags).option('-s, --statsd-server <url>', 'statsd server (host:port)', commandLineDefaults.statsdServer).option('--statsd-tags <tags>', 'additional statsd tags (comma separated name=value pairs)', commandLineDefaults.statsdTags).option('--keep-alive <ms>', 'additional statsd tags (comma separated name=value pairs)', commandLineDefaults.keepAlive).parse(process.argv);
const config = (0, _config.createConfig)(program, process.env, _config.defaultOptions);
const logs = new _logs.default();
const configLog = logs.create('config');
configLog.debug('USE', config);
const server = new _server.default({
  config,
  logs
});

function main() {
  (async () => {
    try {
      await server.start();
    } catch (error) {
      server.log.error('FAILED', 'START', error);
      process.exit(1);
    }
  })();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci9pbmRleC5qcyJdLCJuYW1lcyI6WyJwcm9ncmFtIiwicmVxdWlyZSIsImNvbW1hbmRMaW5lRGVmYXVsdHMiLCJwcm9jZXNzIiwiZW52IiwiZGVmYXVsdE9wdGlvbnMiLCJvcHRpb24iLCJob3N0IiwicG9ydCIsInJwY1BvcnQiLCJyZXF1ZXN0c01vZGUiLCJyZXF1ZXN0c1NlcnZlciIsInJlcXVlc3RzVG9waWMiLCJkYlNlcnZlciIsImRiTmFtZSIsImRiQXV0aCIsImRiTWF4U29ja2V0cyIsInNsb3dEYlNlcnZlciIsInNsb3dEYk5hbWUiLCJzbG93RGJBdXRoIiwic2xvd0RiTWF4U29ja2V0cyIsImF1dGhFbmRwb2ludCIsIm1hbUFjY2Vzc0tleXMiLCJqYWVnZXJFbmRwb2ludCIsInRyYWNlU2VydmljZSIsInRyYWNlVGFncyIsInN0YXRzZFNlcnZlciIsInN0YXRzZFRhZ3MiLCJrZWVwQWxpdmUiLCJwYXJzZSIsImFyZ3YiLCJjb25maWciLCJsb2dzIiwiUUxvZ3MiLCJjb25maWdMb2ciLCJjcmVhdGUiLCJkZWJ1ZyIsInNlcnZlciIsIlRPTlFTZXJ2ZXIiLCJtYWluIiwic3RhcnQiLCJlcnJvciIsImxvZyIsImV4aXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFrQkE7O0FBRUE7O0FBQ0E7Ozs7QUFyQkE7Ozs7Ozs7Ozs7Ozs7OztBQXVCQSxNQUFNQSxPQUFPLEdBQUdDLE9BQU8sQ0FBQyxXQUFELENBQXZCOztBQUNBLE1BQU1DLG1CQUFtQixHQUFHLDRCQUFlLEVBQWYsRUFBbUJDLE9BQU8sQ0FBQ0MsR0FBM0IsRUFBZ0NDLHNCQUFoQyxDQUE1QjtBQUVBTCxPQUFPLENBQ0ZNLE1BREwsQ0FDWSxtQkFEWixFQUNpQyxtQkFEakMsRUFDc0RKLG1CQUFtQixDQUFDSyxJQUQxRSxFQUVLRCxNQUZMLENBRVksbUJBRlosRUFFaUMsZ0JBRmpDLEVBRW1ESixtQkFBbUIsQ0FBQ00sSUFGdkUsRUFHS0YsTUFITCxDQUdZLG1CQUhaLEVB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QTJCLE9BQTNCLEVBQW9DQSxLQUFwQztBQUNBdEMsTUFBQUEsT0FBTyxDQUFDd0MsSUFBUixDQUFhLENBQWI7QUFDSDtBQUNKLEdBUEQ7QUFRSCIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAxOC0yMDIwIFRPTiBERVYgU09MVVRJT05TIExURC5cbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgU09GVFdBUkUgRVZBTFVBVElPTiBMaWNlbnNlICh0aGUgXCJMaWNlbnNlXCIpOyB5b3UgbWF5IG5vdCB1c2VcbiAqIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLiAgWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZVxuICogTGljZW5zZSBhdDpcbiAqXG4gKiBodHRwOi8vd3d3LnRvbi5kZXYvbGljZW5zZXNcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIFRPTiBERVYgc29mdHdhcmUgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuLy8gQGZsb3dcblxuaW1wb3J0IHtjcmVhdGVDb25maWcsIGRlZmF1bHRPcHRpb25zLCByZXNvbHZlT3B0aW9uc30gZnJvbSAnLi9jb25maWcnO1xuaW1wb3J0IHR5cGUgeyBRQ29uZmlnIH0gZnJvbSBcIi4vY29uZmlnXCI7XG5pbXBvcnQgVE9OUVNlcnZlciBmcm9tICcuL3NlcnZlcic7XG5pbXBvcnQgUUxvZ3MgZnJvbSAnLi9sb2dzJztcblxuY29uc3QgcHJvZ3JhbSA9IHJlcXVpcmUoJ2NvbW1hbmRlcicpO1xuY29uc3QgY29tbWFuZExpbmVEZWZhdWx0cyA9IHJlc29sdmVPcHRpb25zKHt9LCBwcm9jZXNzLmVudiwgZGVmYXVsdE9wdGlvbnMpO1xuXG5wcm9ncmFtXG4gICAgLm9wdGlvbignLWgsIC0taG9zdCA8aG9zdD4nLCAnbGlzdGVuaW5nIGFkZHJlc3MnLCBjb21tYW5kTGluZURlZmF1bHRzLmhvc3QpXG4gICAgLm9wdGlvbignLXAsIC0tcG9ydCA8cG9ydD4nLCAnbGlzdGVuaW5nIHBvcnQnLCBjb21tYW5kTGluZURlZmF1bHRzLnBvcnQpXG4gICAgLm9wdGlvbignLS1ycGMtcG9ydCA8cG9ydD4nLCAnbGlzdGVuaW5nIHJwYyBwb3J0JywgY29tbWFuZExpbmVEZWZhdWx0cy5ycGNQb3J0KVxuXG4gICAgLm9wdGlvbignLW0sIC0tcmVxdWVzdHMtbW9kZSA8bW9kZT4nLCAnUmVxdWVzdHMgbW9kZSAoa2Fma2EgfCByZXN0KScsIGNvbW1hbmRMaW5lRGVmYXVsdHMucmVxdWVzdHNNb2RlKVxuICAgIC5vcHRpb24oJy1yLCAtLXJlcXVlc3RzLXNlcnZlciA8dXJsPicsICdSZXF1ZXN0cyBzZXJ2ZXIgdXJsJywgY29tbWFuZExpbmVEZWZhdWx0cy5yZXF1ZXN0c1NlcnZlcilcbiAgICAub3B0aW9uKCctdCwgLS1yZXF1ZXN0cy10b3BpYyA8bmFtZT4nLCAnUmVxdWVzdHMgdG9waWMgbmFtZScsIGNvbW1hbmRMaW5lRGVmYXVsdHMucmVxdWVzdHNUb3BpYylcblxuICAgIC5vcHRpb24oJy1kLCAtLWRiLXNlcnZlciA8YWRkcmVzcz4nLCAnZGF0YWJhc2Ugc2VydmVyOnBvcnQnLCBjb21tYW5kTGluZURlZmF1bHRzLmRiU2VydmVyKVxuICAgIC5vcHRpb24oJy1uLCAtLWRiLW5hbWUgPG5hbWU+JywgJ2RhdGFiYXNlIG5hbWUnLCBjb21tYW5kTGluZURlZmF1bHRzLmRiTmFtZSlcbiAgICAub3B0aW9uKCctYSwgLS1kYi1hdXRoIDxuYW1lPicsICdkYXRhYmFzZSBhdXRoIGluIGZvcm0gXCJ1c2VyOnBhc3N3b3JkJywgY29tbWFuZExpbmVEZWZhdWx0cy5kYkF1dGgpXG4gICAgLm9wdGlvbignLS1kYi1tYXgtc29ja2V0cyA8bnVtYmVyPicsICdkYXRhYmFzZSBtYXggc29ja2V0cycsIGNvbW1hbmRMaW5lRGVmYXVsdHMuZGJNYXhTb2NrZXRzKVxuXG4gICAgLm9wdGlvbignLS1zbG93LWRiLXNlcnZlciA8YWRkcmVzcz4nLCAnc2xvdyBxdWVyaWVzIGRhdGFiYXNlIHNlcnZlcjpwb3J0JywgY29tbWFuZExpbmVEZWZhdWx0cy5zbG93RGJTZXJ2ZXIpXG4gICAgLm9wdGlvbignLS1zbG93LWRiLW5hbWUgPG5hbWU+JywgJ3Nsb3cgZGF0YWJhc2UgbmFtZScsIGNvbW1hbmRMaW5lRGVmYXVsdHMuc2xvd0RiTmFtZSlcbiAgICAub3B0aW9uKCctLXNsb3ctZGItYXV0aCA8bmFtZT4nLCAnc2xvdyBkYXRhYmFzZSBhdXRoIGluIGZvcm0gXCJ1c2VyOnBhc3N3b3JkJywgY29tbWFuZExpbmVEZWZhdWx0cy5zbG93RGJBdXRoKVxuICAgIC5vcHRpb24oJy0tc2xvdy1kYi1tYXgtc29ja2V0cyA8bnVtYmVyPicsICdzbG93IGRhdGFiYXNlIG1heCBzb2NrZXRzJywgY29tbWFuZExpbmVEZWZhdWx0cy5zbG93RGJNYXhTb2NrZXRzKVxuXG4gICAgLm9wdGlvbignLS1hdXRoLWVuZHBvaW50IDx1cmw+JywgJ2F1dGggZW5kcG9pbnQnLCBjb21tYW5kTGluZURlZmF1bHRzLmF1dGhFbmRwb2ludClcbiAgICAub3B0aW9uKCctLW1hbS1hY2Nlc3Mta2V5cyA8a2V5cz4nLCAnQWNjZXNzIGtleXMgdXNlZCB0byBhdXRob3JpemUgbWFtIGVuZHBvaW50IGFjY2VzcycsIGNvbW1hbmRMaW5lRGVmYXVsdHMubWFtQWNjZXNzS2V5cylcblxuICAgIC5vcHRpb24oJy1qLCAtLWphZWdlci1lbmRwb2ludCA8dXJsPicsICdqYWVnZXIgZW5kcG9pbnQnLCBjb21tYW5kTGluZURlZmF1bHRzLmphZWdlckVuZHBvaW50KVxuICAgIC5vcHRpb24oJy0tdHJhY2Utc2VydmljZSA8bmFtZT4nLCAndHJhY2Ugc2VydmljZSBuYW1lJywgY29tbWFuZExpbmVEZWZhdWx0cy50cmFjZVNlcnZpY2UpXG4gICAgLm9wdGlvbignLS10cmFjZS10YWdzIDx0YWdzPicsICdhZGRpdGlvbmFsIHRyYWNlIHRhZ3MgKGNvbW1hIHNlcGFyYXRlZCBuYW1lPXZhbHVlIHBhaXJzKScsIGNvbW1hbmRMaW5lRGVmYXVsdHMudHJhY2VUYWdzKVxuXG4gICAgLm9wdGlvbignLXMsIC0tc3RhdHNkLXNlcnZlciA8dXJsPicsICdzdGF0c2Qgc2VydmVyIChob3N0OnBvcnQpJywgY29tbWFuZExpbmVEZWZhdWx0cy5zdGF0c2RTZXJ2ZXIpXG4gICAgLm9wdGlvbignLS1zdGF0c2QtdGFncyA8dGFncz4nLCAnYWRkaXRpb25hbCBzdGF0c2QgdGFncyAoY29tbWEgc2VwYXJhdGVkIG5hbWU9dmFsdWUgcGFpcnMpJywgY29tbWFuZExpbmVEZWZhdWx0cy5zdGF0c2RUYWdzKVxuXG4gICAgLm9wdGlvbignLS1rZWVwLWFsaXZlIDxtcz4nLCAnYWRkaXRpb25hbCBzdGF0c2QgdGFncyAoY29tbWEgc2VwYXJhdGVkIG5hbWU9dmFsdWUgcGFpcnMpJywgY29tbWFuZExpbmVEZWZhdWx0cy5rZWVwQWxpdmUpXG5cbiAgICAucGFyc2UocHJvY2Vzcy5hcmd2KTtcblxuXG5jb25zdCBjb25maWc6IFFDb25maWcgPSBjcmVhdGVDb25maWcocHJvZ3JhbSwgcHJvY2Vzcy5lbnYsIGRlZmF1bHRPcHRpb25zKTtcblxuY29uc3QgbG9ncyA9IG5ldyBRTG9ncygpO1xuY29uc3QgY29uZmlnTG9nID0gbG9ncy5jcmVhdGUoJ2NvbmZpZycpO1xuY29uZmlnTG9nLmRlYnVnKCdVU0UnLCBjb25maWcpO1xuXG5jb25zdCBzZXJ2ZXIgPSBuZXcgVE9OUVNlcnZlcih7XG4gICAgY29uZmlnLFxuICAgIGxvZ3MsXG59KTtcblxuZXhwb3J0IGZ1bmN0aW9uIG1haW4oKSB7XG4gICAgKGFzeW5jICgpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IHNlcnZlci5zdGFydCgpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgc2VydmVyLmxvZy5lcnJvcignRkFJTEVEJywgJ1NUQVJUJywgZXJyb3IpO1xuICAgICAgICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgICAgICB9XG4gICAgfSkoKTtcbn1cbiJdfQ==