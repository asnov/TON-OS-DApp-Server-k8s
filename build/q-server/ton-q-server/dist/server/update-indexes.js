"use strict";

const {
  Database
} = require('arangojs');

const {
  BLOCKCHAIN_DB
} = require('./config');

const program = require('commander');

const fetch = require('node-fetch');

function sameFields(a, b) {
  return a.join(',').toLowerCase() === b.join(',').toLowerCase();
}

async function detectRedirect(url) {
  try {
    const response = await fetch(url);
    return new URL(response.url).origin;
  } catch {
    return url;
  }
}

async function updateCollection(collection, db) {
  const dbCollection = db.collection(collection.name);
  const existingIndexes = await dbCollection.indexes();

  for (const existing of existingIndexes) {
    if (!collection.indexes.find(x => sameFields(x.fields, existing.fields))) {
      console.log(`${collection.name}: remove index [${existing.id}] on [${existing.fields.join(',')}]`);
      await dbCollection.dropIndex(existing.id);
    }
  }

  for (const required of collection.indexes) {
    if (!existingIndexes.find(x => sameFields(x.fields, required.fields))) {
      console.log(`${collection.name}: create index on [${required.fields.join(',')}]`);
      let indexCreated = false;

      while (!indexCreated) {
        try {
          await dbCollection.createPersistentIndex(required.fields);
          indexCreated = true;
        } catch (error) {
          if (error.message.toLowerCase().indexOf('timeout') >= 0) {
            console.log(`Index creation failed: ${error.message}. Retrying...`);
          } else {
            throw error;
          }
        }
      }
    }
  }
}

async function updateDb(config) {
  const db = new Database({
    url: await detectRedirect(config.server)
  });

  if (config.auth) {
    const [user, password] = config.auth.split(':');
    db.useBasicAuth(user, password);
  }

  db.useDatabase(config.name);

  for (const collection of [...Object.values(BLOCKCHAIN_DB.collections)]) {
    await updateCollection(collection, db);
  }

  await db.close();
}

function update(servers, options) {
  (async () => {
    let hasErrors = false;

    for (const server of [].concat(servers)) {
      console.log(`Update ${server}`);

      try {
        await updateDb({
          server,
          name: BLOCKCHAIN_DB.name,
          auth: options.auth
        });
      } catch (error) {
        console.error(error.message);
        hasErrors = true;
      }
    }

    process.exit(hasErrors ? 1 : 0);
  })();
}

program.arguments('[servers...]').option('-a, --auth <user:password>', 'user:password', '').action(update).parse(process.argv);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NlcnZlci91cGRhdGUtaW5kZXhlcy5qcyJdLCJuYW1lcyI6WyJEYXRhYmFzZSIsInJlcXVpcmUiLCJCTE9DS0NIQUlOX0RCIiwicHJvZ3JhbSIsImZldGNoIiwic2FtZUZpZWxkcyIsImEiLCJiIiwiam9pbiIsInRvTG93ZXJDYXNlIiwiZGV0ZWN0UmVkaXJlY3QiLCJ1cmwiLCJyZXNwb25zZSIsIlVSTCIsIm9yaWdpbiIsInVwZGF0ZUNvbGxlY3Rpb24iLCJjb2xsZWN0aW9uIiwiZGIiLCJkYkNvbGxlY3Rpb24iLCJuYW1lIiwiZXhpc3RpbmdJbmRleGVzIiwiaW5kZXhlcyIsImV4aXN0aW5nIiwiZmluZCIsIngiLCJmaWVsZHMiLCJjb25zb2xlIiwibG9nIiwiaWQiLCJkcm9wSW5kZXgiLCJyZXF1aXJlZCIsImluZGV4Q3JlYXRlZCIsImNyZWF0ZVBlcnNpc3RlbnRJbmRleCIsImVycm9yIiwibWVzc2FnZSIsImluZGV4T2YiLCJ1cGRhdGVEYiIsImNvbmZpZyIsInNlcnZlciIsImF1dGgiLCJ1c2VyIiwicGFzc3dvcmQiLCJzcGxpdCIsInVzZUJhc2ljQXV0aCIsInVzZURhdGFiYXNlIiwiT2JqZWN0IiwidmFsdWVzIiwiY29sbGVjdGlvbnMiLCJjbG9zZSIsInVwZGF0ZSIsInNlcnZlcnMiLCJvcHRpb25zIiwiaGFzRXJyb3JzIiwiY29uY2F0IiwicHJvY2VzcyIsImV4aXQiLCJhcmd1bWVudHMiLCJvcHRpb24iLCJhY3Rpb24iLCJwYXJzZSIsImFyZ3YiXSwibWFwcGluZ3MiOiI7O0FBQUEsTUFBTTtBQUFFQSxFQUFBQTtBQUFGLElBQWVDLE9BQU8sQ0FBQyxVQUFELENBQTVCOztBQUNBLE1BQU07QUFBRUMsRUFBQUE7QUFBRixJQUFvQkQsT0FBTyxDQUFDLFVBQUQsQ0FBakM7O0FBQ0EsTUFBTUUsT0FBTyxHQUFHRixPQUFPLENBQUMsV0FBRCxDQUF2Qjs7QUFDQSxNQUFNRyxLQUFLLEdBQUdILE9BQU8sQ0FBQyxZQUFELENBQXJCOztBQUVBLFNBQVNJLFVBQVQsQ0FBb0JDLENBQXBCLEVBQXVCQyxDQUF2QixFQUEwQjtBQUN0QixTQUFPRCxDQUFDLENBQUNFLElBQUYsQ0FBTyxHQUFQLEVBQVlDLFdBQVosT0FBOEJGLENBQUMsQ0FBQ0MsSUFBRixDQUFPLEdBQVAsRUFBWUMsV0FBWixFQUFyQztBQUNIOztBQUVELGVBQWVDLGNBQWYsQ0FBOEJDLEdBQTlCLEVBQW1DO0FBQy9CLE1BQUk7QUFDQSxVQUFNQyxRQUFRLEdBQUcsTUFBTVIsS0FBSyxDQUFDTyxHQUFELENBQTVCO0FBQ0EsV0FBTyxJQUFJRSxHQUFKLENBQVFELFFBQVEsQ0FBQ0QsR0FBakIsRUFBc0JHLE1BQTdCO0FBQ0gsR0FIRCxDQUdFLE1BQU07QUFDSixXQUFPSCxHQUFQO0FBQ0g7QUFDSjs7QUFFRCxlQUFlSSxnQkFBZixDQUFnQ0MsVUFBaEMsRUFBNENDLEVBQTVDLEVBQWdEO0FBQzVDLFFBQU1DLFlBQVksR0FBR0QsRUFBRSxDQUFDRCxVQUFILENBQWNBLFVBQVUsQ0FBQ0csSUFBekIsQ0FBckI7QUFDQSxRQUFNQyxlQUFlLEdBQUcsTUFBTUYsWUFBWSxDQUFDRyxPQUFiLEVBQTlCOztBQUNBLE9BQUssTUFBTUMsUUFBWCxJQUF1QkYsZUFBdkIsRUFBd0M7QUFDcEMsUUFBSSxDQUFDSixVQUFVLENBQUNLLE9BQVgsQ0FBbUJFLElBQW5CLENBQXdCQyxDQUFDLElBQUluQixVQUFVLENBQUNtQixDQUFDLENBQUNDLE1BQUgsRUFBV0gsUUFBUSxDQUFDRyxNQUFwQixDQUF2QyxDQUFMLEVBQTBFO0FBQ3RFQyxNQUFBQSxPQUFPLENBQUNDLEdBQVIsQ0FBYSxHQUFFWCxVQUFVLENBQUNHLElBQUssbUJBQWtCRyxRQUFRLENBQUNNLEVBQUcsU0FBUU4sUUFBUSxDQUFDRyxNQUFULENBQWdCakIsSUFBaEIsQ0FBcUIsR0FBckIsQ0FBMEIsR0FBL0Y7QUFDQSxZQUFNVSxZQUFZLENBQUNXLFNBQWIsQ0FBdUJQLFFBQVEsQ0FBQ00sRUFBaEMsQ0FBTjtBQUNIO0FBQ0o7O0FBQ0QsT0FBSyxNQUFNRSxRQUFYLElBQXVCZCxVQUFVLENBQUNLLE9BQWxDLEVBQTJDO0FBQ3ZDLFFBQUksQ0FBQ0QsZUFBZSxDQUFDRyxJQUFoQixDQUFxQkMsQ0FBQyxJQUFJbkIsVUFBVSxDQUFDbUIsQ0FBQyxDQUFDQyxNQUFILEVBQVdLLFFBQVEsQ0FBQ0wsTUFBcEIsQ0FBcEMsQ0FBTCxFQUF1RTtBQUNuRUMsTUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQWEsR0FBRVgsVUFBVSxDQUFDRyxJQUFLLHNCQUFxQlcsUUFBUSxDQUFDTCxNQUFULENBQWdCakIsSUFBaEIsQ0FBcUIsR0FBckIsQ0FBMEIsR0FBOUU7QUFDQSxVQUFJdUIsWUFBWSxHQUFHLEtBQW5COztBQUNBLGFBQU8sQ0FBQ0EsWUFBUixFQUFzQjtBQUNsQixZQUFJO0FBQ0EsZ0JBQU1iLFlBQVksQ0FBQ2MscUJBQWIsQ0FBbUNGLFFBQVEsQ0FBQ0wsTUFBNUMsQ0FBTjtBQUNBTSxVQUFBQSxZQUFZLEdBQUcsSUFBZjtBQUNILFNBSEQsQ0FHRSxPQUFNRSxLQUFOLEVBQWE7QUFDWCxjQUFJQSxLQUFLLENBQUNDLE9BQU4sQ0FBY3pCLFdBQWQsR0FBNEIwQixPQUE1QixDQUFvQyxTQUFwQyxLQUFrRCxDQUF0RCxFQUF5RDtBQUNyRFQsWUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQWEsMEJBQXlCTSxLQUFLLENBQUNDLE9BQVEsZUFBcEQ7QUFDSCxXQUZELE1BRU87QUFDSCxrQkFBTUQsS0FBTjtBQUNIO0FBQ0o7QUFDSjtBQUNKO0FBQ0o7QUFDSjs7QUFFRCxlQUFlRyxRQUFmLENBQXdCQyxNQUF4QixFQUFnQztBQUM1QixRQUFNcEIsRUFBRSxHQUFHLElBQUlqQixRQUFKLENBQWE7QUFDcEJXLElBQUFBLEdBQUcsRUFBRSxNQUFNRCxjQUFjLENBQUMyQixNQUFNLENBQUNDLE1BQVI7QUFETCxHQUFiLENBQVg7O0FBSUEsTUFBSUQsTUFBTSxDQUFDRSxJQUFYLEVBQWlCO0FBQ2IsVUFBTSxDQUFDQyxJQUFELEVBQU9DLFFBQVAsSUFBbUJKLE1BQU0sQ0FBQ0UsSUFBUCxDQUFZRyxLQUFaLENBQWtCLEdBQWxCLENBQXpCO0FBQ0F6QixJQUFBQSxFQUFFLENBQUMwQixZQUFILENBQWdCSCxJQUFoQixFQUFzQkMsUUFBdEI7QUFDSDs7QUFDRHhCLEVBQUFBLEVBQUUsQ0FBQzJCLFdBQUgsQ0FBZVAsTUFBTSxDQUFDbEIsSUFBdEI7O0FBQ0EsT0FBSyxNQUFNSCxVQUFYLElBQXlCLENBQUMsR0FBRzZCLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjNUMsYUFBYSxDQUFDNkMsV0FBNUIsQ0FBSixDQUF6QixFQUF3RTtBQUNwRSxVQUFNaEMsZ0JBQWdCLENBQUNDLFVBQUQsRUFBYUMsRUFBYixDQUF0QjtBQUNIOztBQUNELFFBQU1BLEVBQUUsQ0FBQytCLEtBQUgsRUFBTjtBQUNIOztBQUVELFNBQVNDLE1BQVQsQ0FBZ0JDLE9BQWhCLEVBQXlCQyxPQUF6QixFQUFrQztBQUM5QixHQUFDLFlBQVk7QUFDVCxRQUFJQyxTQUFTLEdBQUcsS0FBaEI7O0FBQ0EsU0FBSyxNQUFNZCxNQUFYLElBQXFCLEdBQUdlLE1BQUgsQ0FBVUgsT0FBVixDQUFyQixFQUF5QztBQUNyQ3hCLE1BQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFhLFVBQVNXLE1BQU8sRUFBN0I7O0FBQ0EsVUFBSTtBQUNBLGNBQU1GLFFBQVEsQ0FBQztBQUNYRSxVQUFBQSxNQURXO0FBRVhuQixVQUFBQSxJQUFJLEVBQUVqQixhQUFhLENBQUNpQixJQUZUO0FBR1hvQixVQUFBQSxJQUFJLEVBQUVZLE9BQU8sQ0FBQ1o7QUFISCxTQUFELENBQWQ7QUFLSCxPQU5ELENBTUUsT0FBT04sS0FBUCxFQUFjO0FBQ1pQLFFBQUFBLE9BQU8sQ0FBQ08sS0FBUixDQUFjQSxLQUFLLENBQUNDLE9BQXBCO0FBQ0FrQixRQUFBQSxTQUFTLEdBQUcsSUFBWjtBQUNIO0FBQ0o7O0FBQ0RFLElBQUFBLE9BQU8sQ0FBQ0MsSUFBUixDQUFhSCxTQUFTLEdBQUcsQ0FBSCxHQUFPLENBQTdCO0FBQ0gsR0FoQkQ7QUFpQkg7O0FBRURqRCxPQUFPLENBQ0ZxRCxTQURMLENBQ2UsY0FEZixFQUVLQyxNQUZMLENBRVksNEJBRlosRUFFMEMsZUFGMUMsRUFFMkQsRUFGM0QsRUFHS0MsTUFITCxDQUdZVCxNQUhaLEVBSUtVLEtBSkwsQ0FJV0wsT0FBTyxDQUFDTSxJQUpuQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgRGF0YWJhc2UgfSA9IHJlcXVpcmUoJ2FyYW5nb2pzJyk7XG5jb25zdCB7IEJMT0NLQ0hBSU5fREIgfSA9IHJlcXVpcmUoJy4vY29uZmlnJyk7XG5jb25zdCBwcm9ncmFtID0gcmVxdWlyZSgnY29tbWFuZGVyJyk7XG5jb25zdCBmZXRjaCA9IHJlcXVpcmUoJ25vZGUtZmV0Y2gnKTtcblxuZnVuY3Rpb24gc2FtZUZpZWxkcyhhLCBiKSB7XG4gICAgcmV0dXJuIGEuam9pbignLCcpLnRvTG93ZXJDYXNlKCkgPT09IGIuam9pbignLCcpLnRvTG93ZXJDYXNlKCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRldGVjdFJlZGlyZWN0KHVybCkge1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsKTtcbiAgICAgICAgcmV0dXJuIG5ldyBVUkwocmVzcG9uc2UudXJsKS5vcmlnaW47XG4gICAgfSBjYXRjaCB7XG4gICAgICAgIHJldHVybiB1cmw7XG4gICAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVDb2xsZWN0aW9uKGNvbGxlY3Rpb24sIGRiKSB7XG4gICAgY29uc3QgZGJDb2xsZWN0aW9uID0gZGIuY29sbGVjdGlvbihjb2xsZWN0aW9uLm5hbWUpO1xuICAgIGNvbnN0IGV4aXN0aW5nSW5kZXhlcyA9IGF3YWl0IGRiQ29sbGVjdGlvbi5pbmRleGVzKCk7XG4gICAgZm9yIChjb25zdCBleGlzdGluZyBvZiBleGlzdGluZ0luZGV4ZXMpIHtcbiAgICAgICAgaWYgKCFjb2xsZWN0aW9uLmluZGV4ZXMuZmluZCh4ID0+IHNhbWVGaWVsZHMoeC5maWVsZHMsIGV4aXN0aW5nLmZpZWxkcykpKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgJHtjb2xsZWN0aW9uLm5hbWV9OiByZW1vdmUgaW5kZXggWyR7ZXhpc3RpbmcuaWR9XSBvbiBbJHtleGlzdGluZy5maWVsZHMuam9pbignLCcpfV1gKTtcbiAgICAgICAgICAgIGF3YWl0IGRiQ29sbGVjdGlvbi5kcm9wSW5kZXgoZXhpc3RpbmcuaWQpO1xuICAgICAgICB9XG4gICAgfVxuICAgIGZvciAoY29uc3QgcmVxdWlyZWQgb2YgY29sbGVjdGlvbi5pbmRleGVzKSB7XG4gICAgICAgIGlmICghZXhpc3RpbmdJbmRleGVzLmZpbmQoeCA9PiBzYW1lRmllbGRzKHguZmllbGRzLCByZXF1aXJlZC5maWVsZHMpKSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coYCR7Y29sbGVjdGlvbi5uYW1lfTogY3JlYXRlIGluZGV4IG9uIFske3JlcXVpcmVkLmZpZWxkcy5qb2luKCcsJyl9XWApO1xuICAgICAgICAgICAgbGV0IGluZGV4Q3JlYXRlZCA9IGZhbHNlO1xuICAgICAgICAgICAgd2hpbGUgKCFpbmRleENyZWF0ZWQpIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBkYkNvbGxlY3Rpb24uY3JlYXRlUGVyc2lzdGVudEluZGV4KHJlcXVpcmVkLmZpZWxkcyk7XG4gICAgICAgICAgICAgICAgICAgIGluZGV4Q3JlYXRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfSBjYXRjaChlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3IubWVzc2FnZS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJ3RpbWVvdXQnKSA+PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgSW5kZXggY3JlYXRpb24gZmFpbGVkOiAke2Vycm9yLm1lc3NhZ2V9LiBSZXRyeWluZy4uLmApO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZURiKGNvbmZpZykge1xuICAgIGNvbnN0IGRiID0gbmV3IERhdGFiYXNlKHtcbiAgICAgICAgdXJsOiBhd2FpdCBkZXRlY3RSZWRpcmVjdChjb25maWcuc2VydmVyKSxcblxuICAgIH0pO1xuICAgIGlmIChjb25maWcuYXV0aCkge1xuICAgICAgICBjb25zdCBbdXNlciwgcGFzc3dvcmRdID0gY29uZmlnLmF1dGguc3BsaXQoJzonKTtcbiAgICAgICAgZGIudXNlQmFzaWNBdXRoKHVzZXIsIHBhc3N3b3JkKTtcbiAgICB9XG4gICAgZGIudXNlRGF0YWJhc2UoY29uZmlnLm5hbWUpO1xuICAgIGZvciAoY29uc3QgY29sbGVjdGlvbiBvZiBbLi4uT2JqZWN0LnZhbHVlcyhCTE9DS0NIQUlOX0RCLmNvbGxlY3Rpb25zKV0pIHtcbiAgICAgICAgYXdhaXQgdXBkYXRlQ29sbGVjdGlvbihjb2xsZWN0aW9uLCBkYik7XG4gICAgfVxuICAgIGF3YWl0IGRiLmNsb3NlKCk7XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZShzZXJ2ZXJzLCBvcHRpb25zKSB7XG4gICAgKGFzeW5jICgpID0+IHtcbiAgICAgICAgbGV0IGhhc0Vycm9ycyA9IGZhbHNlO1xuICAgICAgICBmb3IgKGNvbnN0IHNlcnZlciBvZiBbXS5jb25jYXQoc2VydmVycykpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBVcGRhdGUgJHtzZXJ2ZXJ9YCk7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHVwZGF0ZURiKHtcbiAgICAgICAgICAgICAgICAgICAgc2VydmVyLFxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBCTE9DS0NIQUlOX0RCLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGF1dGg6IG9wdGlvbnMuYXV0aCxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnJvci5tZXNzYWdlKTtcbiAgICAgICAgICAgICAgICBoYXNFcnJvcnMgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHByb2Nlc3MuZXhpdChoYXNFcnJvcnMgPyAxIDogMCk7XG4gICAgfSkoKTtcbn1cblxucHJvZ3JhbVxuICAgIC5hcmd1bWVudHMoJ1tzZXJ2ZXJzLi4uXScpXG4gICAgLm9wdGlvbignLWEsIC0tYXV0aCA8dXNlcjpwYXNzd29yZD4nLCAndXNlcjpwYXNzd29yZCcsICcnKVxuICAgIC5hY3Rpb24odXBkYXRlKVxuICAgIC5wYXJzZShwcm9jZXNzLmFyZ3YpO1xuXG5cblxuIl19